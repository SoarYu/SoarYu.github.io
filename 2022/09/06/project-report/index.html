<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.soar2568.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="【结题报告】Nacos-CoreDNS模块支持以长连接访问Nacos服务端">
<meta property="og:type" content="article">
<meta property="og:title" content="ospp记录（四）结题报告">
<meta property="og:url" content="http://blog.soar2568.top/2022/09/06/project-report/index.html">
<meta property="og:site_name" content="Soar2568">
<meta property="og:description" content="【结题报告】Nacos-CoreDNS模块支持以长连接访问Nacos服务端">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1664196977944-f4258097-3823-4984-8814-4cae3ed8cdb1.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1664196982731-98f47454-b143-4968-a2e8-223d287d106e.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1658123188046-9eba3156-f960-415f-bd84-68a586dbc189.png#crop=0&crop=0&crop=1&crop=1&id=GKReH&originHeight=711&originWidth=841&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235900753-b4c1b719-bd97-484d-85c3-7b4cc2857858.png#crop=0&crop=0&crop=1&crop=1&id=o7c3j&originHeight=100&originWidth=800&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235907742-ff276893-12f7-422d-b68b-11de9009295f.png#crop=0&crop=0&crop=1&crop=1&id=SWIpv&originHeight=105&originWidth=799&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235912610-bb19fa61-93a4-4e7e-a426-883ec6ac702d.png#crop=0&crop=0&crop=1&crop=1&id=IZjR3&originHeight=101&originWidth=801&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235917042-499d4924-c2b3-4f08-9cc3-7f7439904553.png#crop=0&crop=0&crop=1&crop=1&id=MH0ma&originHeight=95&originWidth=799&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235925262-741dbe46-6a47-47dc-afbc-83f08403853b.png#crop=0&crop=0&crop=1&crop=1&id=dGoe9&originHeight=88&originWidth=800&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235933413-c05baf72-43a3-4a0d-8f99-a817cd6cc6f9.png#crop=0&crop=0&crop=1&crop=1&id=ApssP&originHeight=97&originWidth=801&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235941664-68c7fca4-c643-4b0a-bacc-b6bee6f0f2db.png#crop=0&crop=0&crop=1&crop=1&id=mwKYF&originHeight=163&originWidth=828&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="article:published_time" content="2022-09-06T19:47:43.000Z">
<meta property="article:modified_time" content="2023-07-04T08:09:47.316Z">
<meta property="article:author" content="SoarYu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2022/png/29425667/1664196977944-f4258097-3823-4984-8814-4cae3ed8cdb1.png">

<link rel="canonical" href="http://blog.soar2568.top/2022/09/06/project-report/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>ospp记录（四）结题报告 | Soar2568</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Soar2568</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.soar2568.top/2022/09/06/project-report/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SoarYu">
      <meta itemprop="description" content="Done is better than perfect!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Soar2568">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ospp记录（四）结题报告
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-06 19:47:43" itemprop="dateCreated datePublished" datetime="2022-09-06T19:47:43+00:00">2022-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-07-04 08:09:47" itemprop="dateModified" datetime="2023-07-04T08:09:47+00:00">2023-07-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ospp%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">ospp记录</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="【结题报告】Nacos-CoreDNS模块支持以长连接访问Nacos服务端"><a href="#【结题报告】Nacos-CoreDNS模块支持以长连接访问Nacos服务端" class="headerlink" title="【结题报告】Nacos-CoreDNS模块支持以长连接访问Nacos服务端"></a>【结题报告】Nacos-CoreDNS模块支持以长连接访问Nacos服务端</h1><span id="more"></span>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>[TOC]</p>
<h2 id="项目信息"><a href="#项目信息" class="headerlink" title="项目信息"></a>项目信息</h2><h3 id="项目名称：Nacos-CoreDNS模块支持以长连接访问Nacos服务端"><a href="#项目名称：Nacos-CoreDNS模块支持以长连接访问Nacos服务端" class="headerlink" title="项目名称：Nacos-CoreDNS模块支持以长连接访问Nacos服务端"></a>项目名称：Nacos-CoreDNS模块支持以长连接访问Nacos服务端</h3><h3 id="项目产出："><a href="#项目产出：" class="headerlink" title="项目产出："></a>项目产出：</h3><ul>
<li><input checked="" disabled="" type="checkbox"> <ol>
<li>设计出Nacos CoreDNS模块支持gRPC的方案，输出详细设计文档；</li>
</ol>
</li>
<li><input checked="" disabled="" type="checkbox"> <ol start="2">
<li>根据设计文档，对Nacos CoreDNS模块进行开发；</li>
</ol>
</li>
<li><input checked="" disabled="" type="checkbox"> <ol start="3">
<li>提供新Nacos CoreDNS模块的使用示例和文档。</li>
</ol>
</li>
</ul>
<h3 id="方案描述："><a href="#方案描述：" class="headerlink" title="方案描述："></a>方案描述：</h3><p>当前 Nacos-CoreDNS-Plugin 插件是通过HTTP短连接方式调用Nacos服务端的 API 来请求获取nacos服务端的资源信息。 而在nacos版本v2.x后，原来v1.x版本的API已经被移除，替换成了建立gRPC连接的方式通过gRPC请求来访问获取nacos服务端的资源信息。<br>因此本项目的方案可以参考Nacos-go-sdk与Nacos服务器的通信方式，在Nacos-coredns-plugin内导入Nacos-sdk-go相关功能，封装成新的grpc通信模块，实现nacos-coredns插件与nacos服务器的通信。<br>例如，通过nacos-go-sdk来调用GetAllServicesInfo、GetService等方法，就能获取所有服务或某个具体服务的信息（ip、port…），这些数据可以覆盖nacos v1版本api传输的数据，因此只需要对从nacos服务端获取的数据转成对应coredns插件需要的数据结构即可。</p>
<h4 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h4><ol>
<li>构建客户端：通过在coredns插件中导入nacos-go-sdk&#x2F;v2包，搭建一个nacos-coredns插件和nacos服务通信的客户端 </li>
<li>根据插件的资源需求，封装sdk方法， 完成通信中的数据交换：</li>
</ol>
<ul>
<li>GetAllServicesInfo: 请求获取Nacos服务端里注册的所有服务名</li>
<li>GetService:  请求获取Nacos服务端某个服务的具体信息</li>
<li>Subscribe:   订阅Nacos服务端某个服务</li>
<li>Unsubsrcibe: 取消订阅Nacos服务端某个服务</li>
<li>Callback:    当Nacos服务端的订阅服务发生改变时，通过回调函数更新客户端的服务数据</li>
<li>HasSubcribed: 记录当前服务是否订阅，避免重复订阅</li>
</ul>
<ol start="3">
<li>替换原来插件的数据结构：原来的nacos-coredns插件的数据结构与新版nacos服务端gRPC请求返回的数据结构冲突不兼容，需要放弃原来的数据结构，更新为新版的数据结构。</li>
</ol>
<p><strong>grpc客户端的类设计图</strong><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1664196977944-f4258097-3823-4984-8814-4cae3ed8cdb1.png" alt="NacosGrpcClient.drawio.png"></p>
<h4 id="grpc通信流程设计"><a href="#grpc通信流程设计" class="headerlink" title="grpc通信流程设计"></a>grpc通信流程设计</h4><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1664196982731-98f47454-b143-4968-a2e8-223d287d106e.png" alt="grpc-design.png"><br>1、启动nacos-coredns插件时，同时启动插件与nacos服务器的grpc通信客户端（nacos_grpc_client）。<br>2、grpc通信客户端调用了Nacos-go-sdk&#x2F;v2中实现的方法，从nacos服务器集群中获取一个服务器的IP地址和端口并建立TCP连接。HTTP&#x2F;2下，同个域名只需要占用一个 TCP 连接，使用一个连接并行发送多个请求和响应。<br>3、nacos-coredns插件向Nacos服务器请求资源时，通过grpc通信客户端来调用nacos-go-sdk&#x2F;v2封装的GetAllServicesInfo、GetService等方法来获取所有服务或某个具体服务的信息详情（ip、port…）。<br>4、grpc通信客户端将从nacos服务器里获取到的数据存入nacos-coredns插件的数据缓存中，待插件处理DNS请求时输出数据。<br>5、对grpc通信客户端设置 超时时间 与 重试次数 等措施来避免调用超时、 阻塞等情况。</p>
<h3 id="方案具体实现："><a href="#方案具体实现：" class="headerlink" title="方案具体实现："></a>方案具体实现：</h3><h4 id="一、-构建客户端"><a href="#一、-构建客户端" class="headerlink" title="一、 构建客户端"></a>一、 构建客户端</h4><p>在 Nacos-CoreDNS-Plugin 插件中导入nacos-go-sdk&#x2F;v2包， 来与要访问的nacos服务端集群建立gRPC连接。<br>与nacos服务端建立gRPC需要两个参数  <strong>clientConfig</strong> 和  <strong>serverConfig</strong>. </p>
<ul>
<li><p>clientConfig 是针对本项目作为向服务端请求资源的客户端 来配置 对nacos服务端的 NamespaceId 请求超时TimeoutMs 日志目录LogDir 数据缓存目录CacheDir</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nacosGrpcClient.clientConfig = *constant.NewClientConfig(</span><br><span class="line">        constant.WithNamespaceId(namespaceId),</span><br><span class="line">        constant.WithTimeoutMs(<span class="number">5000</span>),</span><br><span class="line">        constant.WithLogDir(LogPath),</span><br><span class="line">        constant.WithCacheDir(CachePath),</span><br><span class="line">        constant.WithNotLoadCacheAtStart(<span class="literal">true</span>),</span><br><span class="line">        constant.WithUpdateCacheWhenEmpty(<span class="literal">true</span>),</span><br><span class="line">        constant.WithLogLevel(<span class="string">&quot;debug&quot;</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>serverConfig 指定服务端集群的Ip地址和端口</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">serverConfigs := <span class="built_in">make</span>([]constant.ServerConfig, <span class="built_in">len</span>(serverHosts))</span><br><span class="line"><span class="keyword">for</span> i, serverHost := <span class="keyword">range</span> serverHosts &#123;</span><br><span class="line">        serverIp := strings.Split(serverHost, <span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        serverPort, err := strconv.Atoi(strings.Split(serverHost, <span class="string">&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            NacosClientLogger.Error(<span class="string">&quot;nacos server host config error!&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">        serverConfigs[i] = *constant.NewServerConfig(</span><br><span class="line">            serverIp,</span><br><span class="line">            <span class="type">uint64</span>(serverPort),</span><br><span class="line">            constant.WithScheme(<span class="string">&quot;http&quot;</span>),</span><br><span class="line">            constant.WithContextPath(<span class="string">&quot;/nacos&quot;</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">nacosGrpcClient.serverConfigs = serverConfigs</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置完成后， 连接建立， 通过此客户端来进行通信</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nacosGrpcClient.grpcClient, err = clients.NewNamingClient(</span><br><span class="line">    vo.NacosClientParam&#123;</span><br><span class="line">        ClientConfig:  &amp;nacosGrpcClient.clientConfig,</span><br><span class="line">        ServerConfigs: nacosGrpcClient.serverConfigs,</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="二、-客户端的主要功能"><a href="#二、-客户端的主要功能" class="headerlink" title="二、 客户端的主要功能"></a>二、 客户端的主要功能</h4><h4 id="根据插件的资源需求，封装sdk方法，-完成通信中的数据交换。"><a href="#根据插件的资源需求，封装sdk方法，-完成通信中的数据交换。" class="headerlink" title="根据插件的资源需求，封装sdk方法， 完成通信中的数据交换。"></a>根据插件的资源需求，封装sdk方法， 完成通信中的数据交换。</h4><ol>
<li><p>GetAllServicesInfo:  对应v1版本的API(&#x2F;v1&#x2F;ns&#x2F;api&#x2F;allDomNames)，通过封装sdk的方法，获取在nacos里注册的所有服务名。	</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ngc *NacosGrpcClient)</span></span> GetAllServicesInfo() []<span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> pageNo = <span class="type">uint32</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">var</span> pageSize = <span class="type">uint32</span>(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">var</span> services []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">    pageServiceList, _ := ngc.grpcClient.GetAllServicesInfo(vo.GetAllServiceInfoParam&#123;</span><br><span class="line">        NameSpace: ngc.namespaceId,</span><br><span class="line">        PageNo:    pageNo,</span><br><span class="line">        PageSize:  pageSize,</span><br><span class="line">    &#125;)</span><br><span class="line">    services = <span class="built_in">append</span>(services, pageServiceList.Doms...)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果当前页数服务数满了, 继续查找添加下一页</span></span><br><span class="line">	<span class="keyword">for</span> pageNo++; <span class="built_in">len</span>(pageServiceList.Doms) &gt;= <span class="type">int</span>(pageSize); pageNo++ &#123;</span><br><span class="line">        pageServiceList, _ = ngc.grpcClient.GetAllServicesInfo(vo.GetAllServiceInfoParam&#123;</span><br><span class="line">            NameSpace: ngc.namespaceId,</span><br><span class="line">            PageNo:    pageNo,</span><br><span class="line">            PageSize:  pageSize,</span><br><span class="line">        &#125;)</span><br><span class="line">        services = <span class="built_in">append</span>(services, pageServiceList.Doms...)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> services</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>GetService:  对应v1版本的API(&#x2F;v1&#x2F;ns&#x2F;api&#x2F;srvIPXT)，输入服务名，通过gRPC请求获该服务的具体信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ngc *NacosGrpcClient)</span></span> GetService(serviceName <span class="type">string</span>) model.Service &#123;</span><br><span class="line">    service, _ := ngc.grpcClient.GetService(vo.GetServiceParam&#123;</span><br><span class="line">        ServiceName: serviceName,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> service.Hosts == <span class="literal">nil</span> &#123;</span><br><span class="line">        NacosClientLogger.Warn(<span class="string">&quot;empty result from server, dom:&quot;</span> + serviceName)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> service</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Subscribe:  订阅Nacos服务端某个服务， 封装sdk中订阅服务的方法，输入服务名，通过gRPC连接完成对该服务的订阅来更新服务数据。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ngc *NacosGrpcClient)</span></span> Subscribe(serviceName <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ngc.HasSubcribed(serviceName) &#123;</span><br><span class="line">        NacosClientLogger.Info(<span class="string">&quot;service &quot;</span> + serviceName + <span class="string">&quot; already subsrcibed.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    param := &amp;vo.SubscribeParam&#123;</span><br><span class="line">        ServiceName:       serviceName,</span><br><span class="line">        GroupName:         <span class="string">&quot;&quot;</span>,</span><br><span class="line">        SubscribeCallback: ngc.Callback,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := ngc.grpcClient.Subscribe(param); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        NacosClientLogger.Error(<span class="string">&quot;service subscribe error &quot;</span> + serviceName)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> ngc.SubscribeMap.DLock.Unlock()</span><br><span class="line">    ngc.SubscribeMap.DLock.Lock()</span><br><span class="line">    ngc.SubscribeMap.Data[serviceName] = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Unsubsrcibe:  取消订阅Nacos服务端某个服务， 封装了sdk中取消订阅服务的方法。当服务下线时，通过gRPC连接来取消该服务的订阅。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ngc *NacosGrpcClient)</span></span> Unsubsrcibe(serviceName <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !ngc.HasSubcribed(serviceName) &#123;</span><br><span class="line">        NacosClientLogger.Info(<span class="string">&quot;service &quot;</span> + serviceName + <span class="string">&quot; already unsubsrcibed.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    param := &amp;vo.SubscribeParam&#123;</span><br><span class="line">        ServiceName:       serviceName,</span><br><span class="line">        GroupName:         <span class="string">&quot;&quot;</span>,</span><br><span class="line">        SubscribeCallback: ngc.Callback,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := ngc.grpcClient.Unsubscribe(param); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        NacosClientLogger.Error(<span class="string">&quot;service unsubscribe error &quot;</span> + serviceName)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> ngc.SubscribeMap.DLock.Unlock()</span><br><span class="line">    ngc.SubscribeMap.DLock.Lock()</span><br><span class="line">    ngc.SubscribeMap.Data[serviceName] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Callback:  当Nacos服务端的订阅服务发生改变时，通过回调函数更新客户端的服务数据。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ngc *NacosGrpcClient)</span></span> Callback(instances []model.Instance, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">//服务下线,更新实例数量为0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(instances) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> serviceName, _ := <span class="keyword">range</span> AllDoms.Data &#123;</span><br><span class="line">            <span class="keyword">if</span> service := ngc.GetService(serviceName); <span class="built_in">len</span>(service.Hosts) == <span class="number">0</span> &#123;</span><br><span class="line">                ngc.nacosClient.GetDomainCache().Set(serviceName, service)</span><br><span class="line">                ngc.Unsubsrcibe(serviceName)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    serviceName := strings.Split(instances[<span class="number">0</span>].ServiceName, SEPERATOR)[<span class="number">1</span>]</span><br><span class="line">    oldService, ok := ngc.nacosClient.GetDomainCache().Get(serviceName)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        NacosClientLogger.Info(<span class="string">&quot;service not found in cache &quot;</span> + serviceName)</span><br><span class="line">        service := ngc.GetService(serviceName)</span><br><span class="line">        ngc.nacosClient.GetDomainCache().Set(serviceName, service)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        service := oldService.(model.Service)</span><br><span class="line">        service.Hosts = instances</span><br><span class="line">        service.LastRefTime = <span class="type">uint64</span>(CurrentMillis())</span><br><span class="line">        ngc.nacosClient.GetDomainCache().Set(serviceName, service)</span><br><span class="line">    &#125;</span><br><span class="line">    NacosClientLogger.Info(<span class="string">&quot;serviceName: &quot;</span>+serviceName+<span class="string">&quot; was updated to: &quot;</span>, instances)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>HasSubcribed:  记录当前服务是否订阅，避免重复订阅。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ngc *NacosGrpcClient)</span></span> HasSubcribed(serviceName <span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> ngc.SubscribeMap.DLock.RUnlock()</span><br><span class="line">    ngc.SubscribeMap.DLock.RLock()</span><br><span class="line">    <span class="keyword">return</span> ngc.SubscribeMap.Data[serviceName]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="三、-替换原来插件的数据结构"><a href="#三、-替换原来插件的数据结构" class="headerlink" title="三、 替换原来插件的数据结构"></a>三、 替换原来插件的数据结构</h4><p>将从nacos服务器里获取到的数据转成对应nacos-coredns插件需要的数据结构<br>将v1版本的数据结构 <strong>Domain</strong> 替换为 <strong>Service</strong>, 并更新 <strong>Instance</strong> 的结构。<br>旧的定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Domain <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name          <span class="type">string</span> <span class="string">`json:&quot;dom&quot;`</span></span><br><span class="line">    Clusters      <span class="type">string</span></span><br><span class="line">    CacheMillis   <span class="type">int64</span></span><br><span class="line">    LastRefMillis <span class="type">int64</span></span><br><span class="line">    Instances     []Instance <span class="string">`json:&quot;hosts&quot;`</span></span><br><span class="line">    Env           <span class="type">string</span></span><br><span class="line">    TTL           <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Instance <span class="keyword">struct</span> &#123;</span><br><span class="line">    IP         <span class="type">string</span></span><br><span class="line">    Port       <span class="type">int</span></span><br><span class="line">    Weight     <span class="type">float64</span></span><br><span class="line">    Valid      <span class="type">bool</span></span><br><span class="line">    Unit       <span class="type">string</span></span><br><span class="line">    AppUseType <span class="type">string</span></span><br><span class="line">    Site       <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新的替换：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Service <span class="keyword">struct</span> &#123;</span><br><span class="line">    CacheMillis              <span class="type">uint64</span>     <span class="string">`json:&quot;cacheMillis&quot;`</span></span><br><span class="line">    Hosts                    []Instance <span class="string">`json:&quot;hosts&quot;`</span></span><br><span class="line">    Checksum                 <span class="type">string</span>     <span class="string">`json:&quot;checksum&quot;`</span></span><br><span class="line">    LastRefTime              <span class="type">uint64</span>     <span class="string">`json:&quot;lastRefTime&quot;`</span></span><br><span class="line">    Clusters                 <span class="type">string</span>     <span class="string">`json:&quot;clusters&quot;`</span></span><br><span class="line">    Name                     <span class="type">string</span>     <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">    GroupName                <span class="type">string</span>     <span class="string">`json:&quot;groupName&quot;`</span></span><br><span class="line">    Valid                    <span class="type">bool</span>       <span class="string">`json:&quot;valid&quot;`</span></span><br><span class="line">    AllIPs                   <span class="type">bool</span>       <span class="string">`json:&quot;allIPs&quot;`</span></span><br><span class="line">    ReachProtectionThreshold <span class="type">bool</span>       <span class="string">`json:&quot;reachProtectionThreshold&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Instance <span class="keyword">struct</span> &#123;</span><br><span class="line">    InstanceId                <span class="type">string</span>            <span class="string">`json:&quot;instanceId&quot;`</span></span><br><span class="line">    Ip                        <span class="type">string</span>            <span class="string">`json:&quot;ip&quot;`</span></span><br><span class="line">    Port                      <span class="type">uint64</span>            <span class="string">`json:&quot;port&quot;`</span></span><br><span class="line">    Weight                    <span class="type">float64</span>           <span class="string">`json:&quot;weight&quot;`</span></span><br><span class="line">    Healthy                   <span class="type">bool</span>              <span class="string">`json:&quot;healthy&quot;`</span></span><br><span class="line">    Enable                    <span class="type">bool</span>              <span class="string">`json:&quot;enabled&quot;`</span></span><br><span class="line">    Ephemeral                 <span class="type">bool</span>              <span class="string">`json:&quot;ephemeral&quot;`</span></span><br><span class="line">    ClusterName               <span class="type">string</span>            <span class="string">`json:&quot;clusterName&quot;`</span></span><br><span class="line">    ServiceName               <span class="type">string</span>            <span class="string">`json:&quot;serviceName&quot;`</span></span><br><span class="line">    Metadata                  <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;metadata&quot;`</span></span><br><span class="line">    InstanceHeartBeatInterval <span class="type">int</span>               <span class="string">`json:&quot;instanceHeartBeatInterval&quot;`</span></span><br><span class="line">    IpDeleteTimeout           <span class="type">int</span>               <span class="string">`json:&quot;ipDeleteTimeout&quot;`</span></span><br><span class="line">    InstanceHeartBeatTimeOut  <span class="type">int</span>               <span class="string">`json:&quot;instanceHeartBeatTimeOut&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="时间规划"><a href="#时间规划" class="headerlink" title="时间规划"></a>时间规划</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 7.01 - 7.14  复用Nacos-Sdk-Go，构建一个简易的Nacos-go客户端与Nacos服务器实现gRPC的通信方式，来熟悉Nacos的go开发，改进设计文档。  </li>
<li><input checked="" disabled="" type="checkbox"> 7.15 - 7.31  借助前面的开发文档和经验，尝试在Nacos-CoreDNS-plugin中添加 grpc客户端模块，建立与 Nacos服务端的gRPC通信。</li>
<li><input checked="" disabled="" type="checkbox"> 8.01 - 8.14  对 Nacos-CoreDNS 插件与Nacos服务端的连接进行细节的优化，保证连接的稳定性。</li>
<li><input checked="" disabled="" type="checkbox"> 8.15 - 8.30  编写单元测试，对新的连接进行性能测试，主要是对比同一个接口在gRPC连接和短连接两种模式下的响应时间和吞吐量进行压力测试。  </li>
<li><input checked="" disabled="" type="checkbox"> 9.01 - 9.14  编写新Nacos CoreDNS模块的使用示例和文档。  </li>
<li><input checked="" disabled="" type="checkbox"> 9.15 - 9.30  对整个项目进行梳理，提交PR，编写项目终期报告。</li>
</ul>
<h2 id="项目总结"><a href="#项目总结" class="headerlink" title="项目总结"></a>项目总结</h2><h3 id="遇到的问题及解决方案："><a href="#遇到的问题及解决方案：" class="headerlink" title="遇到的问题及解决方案："></a>遇到的问题及解决方案：</h3><h4 id="1-nacos旧版本升级到新版本后，原来的API被移除了。"><a href="#1-nacos旧版本升级到新版本后，原来的API被移除了。" class="headerlink" title="1. nacos旧版本升级到新版本后，原来的API被移除了。"></a>1. nacos旧版本升级到新版本后，原来的API被移除了。</h4><p>原来的 Nacos-CoreDNS-Plugin 插件是通过HTTP短连接方式调用Nacos服务端的 API 来请求获取nacos服务端的资源信息。 而在nacos版本v2.x后，原来v1.x版本的API已经被移除，替换成了建立gRPC连接的方式通过gRPC请求来访问获取nacos服务端的资源信息。 因此，可以参考Nacos-go-sdk提供的与Nacos服务器的通信方法，在Nacos-coredns-plugin内导入Nacos-sdk-go相关功能，封装成新的grpc通信模块，实现nacos-coredns插件与nacos服务器的通信。</p>
<h4 id="2-数据缓存问题"><a href="#2-数据缓存问题" class="headerlink" title="2. 数据缓存问题"></a>2. 数据缓存问题</h4><p>原来coredns插件的服务数据默认是缓存在 &#x2F;root&#x2F;nacos-go-client-cache&#x2F; 目录中，且每次更新数据都会将数据写入到文件中，造成的io资源消耗较大。<br>而nacos-sdk-go中自带了对服务的缓存默认是在 &#x2F;tmp&#x2F;nacos&#x2F;cache&#x2F; 目录中，这些缓存的数据都是在插件启动的时候加载的，两者的功能产生了重叠。因此，将原来的nacos-coredns-plugin的缓存功能移除，让nacos-sdk-go管理服务数据的缓存。 </p>
<h4 id="3-数据更新问题"><a href="#3-数据更新问题" class="headerlink" title="3. 数据更新问题"></a>3. 数据更新问题</h4><p>目前nacos-coredns-plugin数据的更新是通过两个goruntime定时向服务器请求来更新数据, 当服务数据频繁变化时，无法及时更新客户端的数据。</p>
<div align="center"> 
<img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1658123188046-9eba3156-f960-415f-bd84-68a586dbc189.png#crop=0&crop=0&crop=1&crop=1&id=GKReH&originHeight=711&originWidth=841&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" style="zoom: 80%; align:center" ></img>
</div>
nacos-sdk-go中提供了Subscribe服务订阅的功能。对某个服务进行订阅后，服务的实例发生改变时会调用客户端定义的回调函数callback。因此，将数据更新的流程调整为：定时从服务器获取所有服务名, 当某个服务接受到DNS请求时，对此服务进行订阅。 当Nacos服务端的订阅服务发生改变时，通过回调函数更新客户端的服务数据。 

<h4 id="4-编译问题"><a href="#4-编译问题" class="headerlink" title="4. 编译问题"></a>4. 编译问题</h4><p>coredns v1.6.7 与 nacos-sdk-go&#x2F;v2 的grpc版本不兼容， 编译时会产生报错。<br>将 nacos-coredns-plugin 原来的 coredns v1.6.7 版本更新到最新的v1.9.3版本，解决原来coredns与nacos-sdk-go的 gRPC版本冲突问题。 </p>
<h3 id="项目测试："><a href="#项目测试：" class="headerlink" title="项目测试："></a>项目测试：</h3><h4 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h4><p>在原来的v1.6.7分支上，修改2个测试用例，新增5个测试用例</p>
<ol>
<li><p>测试用例一：TestNacosClient_getAllServiceNames<br>● 预期结果：获取Nacos服务端里注册的所有服务名并存入AllDoms<br>● 实际结果：成功获取Nacos服务端里注册的所有服务名并存入AllDoms<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235900753-b4c1b719-bd97-484d-85c3-7b4cc2857858.png#crop=0&crop=0&crop=1&crop=1&id=o7c3j&originHeight=100&originWidth=800&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
</li>
<li><p>测试用例二：TestNacosClient_getDomNow<br>● 预期结果：获取Nacos服务端里某个服务的具体信息并存入缓存中<br>● 实际结果：成功获取Nacos服务端里某个服务的具体信息并存入缓存中<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235907742-ff276893-12f7-422d-b68b-11de9009295f.png#crop=0&crop=0&crop=1&crop=1&id=SWIpv&originHeight=105&originWidth=799&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
</li>
<li><p>测试用例三：TestGetAllServicesInfo<br>● 预期结果：gRPC请求获取Nacos服务端里注册的所有服务名<br>● 实际结果：成功通过gRPC请求获取Nacos服务端里注册的所有服务名<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235912610-bb19fa61-93a4-4e7e-a426-883ec6ac702d.png#crop=0&crop=0&crop=1&crop=1&id=IZjR3&originHeight=101&originWidth=801&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
</li>
<li><p>测试用例四：TestGetService<br>● 预期结果：gRPC请求获取Nacos服务端某个服务的具体信息<br>● 实际结果：成功通过gRPC请求获取Nacos服务端某个服务的具体信息<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235917042-499d4924-c2b3-4f08-9cc3-7f7439904553.png#crop=0&crop=0&crop=1&crop=1&id=MH0ma&originHeight=95&originWidth=799&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
</li>
<li><p>测试用例五：TestSubscribe<br>● 预期结果：gRPC订阅Nacos服务端某个服务<br>● 实际结果：成功通过gRPC订阅Nacos服务端某个服务<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235925262-741dbe46-6a47-47dc-afbc-83f08403853b.png#crop=0&crop=0&crop=1&crop=1&id=dGoe9&originHeight=88&originWidth=800&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
</li>
<li><p>测试用例六：TestCallback<br>● 预期结果：当Nacos服务端服务发生改变时，通过回调函数更新客户端的服务数据<br>● 实际结果：当Nacos服务端服务发生改变时，成功通过回调函数更新客户端的服务数据<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235933413-c05baf72-43a3-4a0d-8f99-a817cd6cc6f9.png#crop=0&crop=0&crop=1&crop=1&id=ApssP&originHeight=97&originWidth=801&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
</li>
<li><p>测试用例七：TestNacosParse<br>● 预期结果：通过配置文件配置Nacos服务器的 NamespaceId 和 ip地址和端口 .<br>● 实际结果：成功配置Nacos服务器的 NamespaceId 和 ip地址和端口 .<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29425667/1663235941664-68c7fca4-c643-4b0a-bacc-b6bee6f0f2db.png#crop=0&crop=0&crop=1&crop=1&id=mwKYF&originHeight=163&originWidth=828&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
</li>
</ol>
<p><strong>所有测试用例运行结果</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">=== RUN   TestDnsCache_Updated</span><br><span class="line">    dns_cache_test.go:26: Out of date test is passed</span><br><span class="line">    dns_cache_test.go:32: Updated is passed.</span><br><span class="line">--- PASS: TestDnsCache_Updated (0.00s)</span><br><span class="line">=== RUN   TestGet</span><br><span class="line">    httpclient_test.go:40: Success to test http client get</span><br><span class="line">--- PASS: TestGet (0.00s)</span><br><span class="line">=== RUN   TestNacosClient_GetDomain</span><br><span class="line">--- PASS: TestNacosClient_GetDomain (0.00s)</span><br><span class="line">=== RUN   TestNacosClient_getAllServiceNames</span><br><span class="line">    nacos_client_test.go:75: Get all serviceName from servers passed</span><br><span class="line">--- PASS: TestNacosClient_getAllServiceNames (0.05s)</span><br><span class="line">=== RUN   TestNacosClient_getServiceNow</span><br><span class="line">    nacos_client_test.go:100: Get all servicesInfo from servers passed</span><br><span class="line">--- PASS: TestNacosClient_getServiceNow (2.80s)</span><br><span class="line">=== RUN   TestDomain_SrvInstances</span><br><span class="line">    nacos_domain_test.go:30: Domain.srvInstances weight passed.</span><br><span class="line">    nacos_domain_test.go:37: Domain.srvInstances valid passed.</span><br><span class="line">--- PASS: TestDomain_SrvInstances (0.00s)</span><br><span class="line">=== RUN   TestGetAllServicesInfo</span><br><span class="line">    nacos_grpc_client_test.go:23: GrpcClient get all servicesInfo passed</span><br><span class="line">--- PASS: TestGetAllServicesInfo (0.03s)</span><br><span class="line">=== RUN   TestGetService</span><br><span class="line">    nacos_grpc_client_test.go:39: GrpcClient get service passed</span><br><span class="line">--- PASS: TestGetService (0.03s)</span><br><span class="line">=== RUN   TestSubscribe</span><br><span class="line">    nacos_grpc_client_test.go:54: GrpcClient subscribe service passed</span><br><span class="line">--- PASS: TestSubscribe (0.03s)</span><br><span class="line">=== RUN   TestCallback</span><br><span class="line">    nacos_grpc_client_test.go:181: GrpcClient Service SubscribeCallback passed</span><br><span class="line">--- PASS: TestCallback (0.00s)</span><br><span class="line">=== RUN   TestServerManager_NextServer</span><br><span class="line">    server_manager_test.go:29: ServerManager.NextServer test is passed.</span><br><span class="line">--- PASS: TestServerManager_NextServer (0.00s)</span><br><span class="line">=== RUN   TestServerManager_RefreshServerListIfNeed</span><br><span class="line">    server_manager_test.go:39: ServerManager.RefreshServerListIfNeed test is passed.</span><br><span class="line">--- PASS: TestServerManager_RefreshServerListIfNeed (0.00s)</span><br><span class="line">=== RUN   TestNacosParse</span><br><span class="line">init nacos plugin...</span><br><span class="line">init nacos client.</span><br><span class="line">    setup_test.go:54: Passed</span><br><span class="line">--- PASS: TestNacosParse (1.18s)</span><br><span class="line">=== RUN   TestUDPServer_StartServer</span><br><span class="line">    udp_server_test.go:43: Udp server test passed.</span><br><span class="line">--- PASS: TestUDPServer_StartServer (0.02s)</span><br><span class="line">=== RUN   TestTryDecompressData</span><br><span class="line">    util_and_comms_test.go:32: Gzip test is passed.</span><br><span class="line">--- PASS: TestTryDecompressData (0.00s)</span><br><span class="line">PASS</span><br><span class="line">ok  	nacos-coredns-plugin/nacos	4.624s</span><br></pre></td></tr></table></figure>

<h4 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h4><ol>
<li>测试机器配置<br>腾讯云轻量应用服务器：CPU2核 内存2G 带宽4M。一般而言，CoreDNS比较吃网卡和CPU，对于硬盘IO的要求并不算特别高（主要取决于写日志的量），对内存占用较低。 </li>
<li>测试工具<br>本次测试使用bind9出品的一款DNS服务器性能测试的工具queryperf，对DNS服务器进行压测，并对DNS服务器性能进行评估。 </li>
<li>测试方法<br>使用 queryperf 来对 Coredns-Nacos-Plugin 进行DNS请求，解析在Nacos服务端注册的服务域名。<br>● 本次测试使用的Nacos服务端注册了1000个服务, 共10000个服务实例。</li>
</ol>
<p><strong>v1 版本：Nacos v1.x + Coredns v1.6.7</strong><br>● 50000条DNS请求： 三次测试， 平均qps为 209</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Status] Testing complete</span><br><span class="line"></span><br><span class="line">Statistics:</span><br><span class="line"></span><br><span class="line">  Parse input file:     once</span><br><span class="line">  Ended due to:         reaching end of file</span><br><span class="line">  </span><br><span class="line">  Queries sent:         50000 queries</span><br><span class="line">  Queries completed:    50000 queries</span><br><span class="line">  Queries lost:         0 queries</span><br><span class="line">  Queries delayed(?):   0 queries</span><br><span class="line">  </span><br><span class="line">  RTT max:         	0.428648 sec</span><br><span class="line">  RTT min:              0.000030 sec</span><br><span class="line">  RTT average:          0.011961 sec</span><br><span class="line">  RTT std deviation:    0.016171 sec</span><br><span class="line">  RTT out of range:     0 queries</span><br><span class="line">  </span><br><span class="line">  Percentage completed: 100.00%</span><br><span class="line">  Percentage lost:        0.00%</span><br><span class="line">  </span><br><span class="line">  Started at:           Thu Sep 22 15:49:44 2022</span><br><span class="line">  Finished at:          Thu Sep 22 15:53:53 2022</span><br><span class="line">  Ran for:              249.121087 seconds</span><br><span class="line">  </span><br><span class="line">  Queries per second:   200.705611 qps</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Status] Testing complete</span><br><span class="line"></span><br><span class="line">Statistics:</span><br><span class="line"></span><br><span class="line">  Parse input file:     once</span><br><span class="line">  Ended due to:         reaching end of file</span><br><span class="line">  </span><br><span class="line">  Queries sent:         50000 queries</span><br><span class="line">  Queries completed:    50000 queries</span><br><span class="line">  Queries lost:         0 queries</span><br><span class="line">  Queries delayed(?):   0 queries</span><br><span class="line">  </span><br><span class="line">  RTT max:         	0.485871 sec</span><br><span class="line">  RTT min:              0.000357 sec</span><br><span class="line">  RTT average:          0.011313 sec</span><br><span class="line">  RTT std deviation:    0.012731 sec</span><br><span class="line">  RTT out of range:     0 queries</span><br><span class="line">  </span><br><span class="line">  Percentage completed: 100.00%</span><br><span class="line">  Percentage lost:        0.00%</span><br><span class="line">  </span><br><span class="line">  Started at:           Thu Sep 22 16:24:04 2022</span><br><span class="line">  Finished at:          Thu Sep 22 16:28:10 2022</span><br><span class="line">  Ran for:              245.988585 seconds</span><br><span class="line">  </span><br><span class="line">  Queries per second:   203.261464 qps</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Status] Testing complete</span><br><span class="line"></span><br><span class="line">Statistics:</span><br><span class="line">  </span><br><span class="line">  Parse input file:     once</span><br><span class="line">  Ended due to:         reaching end of file</span><br><span class="line">  </span><br><span class="line">  Queries sent:         50000 queries</span><br><span class="line">  Queries completed:    50000 queries</span><br><span class="line">  Queries lost:         0 queries</span><br><span class="line">  Queries delayed(?):   0 queries</span><br><span class="line">  </span><br><span class="line">  RTT max:         	0.082733 sec</span><br><span class="line">  RTT min:              0.000019 sec</span><br><span class="line">  RTT average:          0.006520 sec</span><br><span class="line">  RTT std deviation:    0.001705 sec</span><br><span class="line">  RTT out of range:     0 queries</span><br><span class="line">  </span><br><span class="line">  Percentage completed: 100.00%</span><br><span class="line">  Percentage lost:        0.00%</span><br><span class="line">  </span><br><span class="line">  Started at:           Wed Sep 22 20:43:30 2022</span><br><span class="line">  Finished at:          Wed Sep 22 20:47:12 2022</span><br><span class="line">  Ran for:              222.443603 seconds</span><br><span class="line">  </span><br><span class="line">  Queries per second:   224.776075 qps</span><br></pre></td></tr></table></figure>


<p><strong>v2版本： Nacos2.1.1 + Coredns 1.9.3</strong><br>50000条DNS请求，三次测试平均qps为：467</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Status] Testing complete</span><br><span class="line"></span><br><span class="line">Statistics:</span><br><span class="line">  </span><br><span class="line">  Parse input file:     once</span><br><span class="line">  Ended due to:         reaching end of file</span><br><span class="line">  </span><br><span class="line">  Queries sent:         50000 queries</span><br><span class="line">  Queries completed:    50000 queries</span><br><span class="line">  Queries lost:         0 queries</span><br><span class="line">  Queries delayed(?):   0 queries</span><br><span class="line">  </span><br><span class="line">  RTT max:         	0.048039 sec</span><br><span class="line">  RTT min:              0.004723 sec</span><br><span class="line">  RTT average:          0.006745 sec</span><br><span class="line">  RTT std deviation:    0.001731 sec</span><br><span class="line">  RTT out of range:     0 queries</span><br><span class="line">  </span><br><span class="line">  Percentage completed: 100.00%</span><br><span class="line">  Percentage lost:        0.00%</span><br><span class="line">  </span><br><span class="line">  Started at:           Thu Sep 22 14:48:29 2022</span><br><span class="line">  Finished at:          Thu Sep 22 14:50:17 2022</span><br><span class="line">  Ran for:              107.771145 seconds</span><br><span class="line">  </span><br><span class="line">  Queries per second:   463.946078 qps</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Status] Testing complete</span><br><span class="line"></span><br><span class="line">Statistics:</span><br><span class="line"></span><br><span class="line">  Parse input file:     once</span><br><span class="line">  Ended due to:         reaching end of file</span><br><span class="line"></span><br><span class="line">  Queries sent:         50000 queries</span><br><span class="line">  Queries completed:    50000 queries</span><br><span class="line">  Queries lost:         0 queries</span><br><span class="line">  Queries delayed(?):   0 queries</span><br><span class="line"></span><br><span class="line">  RTT max:         	0.041432 sec</span><br><span class="line">  RTT min:              0.003126 sec</span><br><span class="line">  RTT average:          0.005235 sec</span><br><span class="line">  RTT std deviation:    0.001552 sec</span><br><span class="line">  RTT out of range:     0 queries</span><br><span class="line"></span><br><span class="line">  Percentage completed: 100.00%</span><br><span class="line">  Percentage lost:        0.00%</span><br><span class="line"></span><br><span class="line">  Started at:           Thu Sep 22 14:52:01 2022</span><br><span class="line">  Finished at:          Thu Sep 22 14:53:49 2022</span><br><span class="line">  Ran for:              107.977801 seconds</span><br><span class="line"></span><br><span class="line">  Queries per second:   463.058143 qps</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Status] Testing complete</span><br><span class="line"></span><br><span class="line">Statistics:</span><br><span class="line">  </span><br><span class="line">  Parse input file:     once</span><br><span class="line">  Ended due to:         reaching end of file</span><br><span class="line">  </span><br><span class="line">  Queries sent:         50000 queries</span><br><span class="line">  Queries completed:    50000 queries</span><br><span class="line">  Queries lost:         0 queries</span><br><span class="line">  Queries delayed(?):   0 queries</span><br><span class="line">  </span><br><span class="line">  RTT max:         	0.039539 sec</span><br><span class="line">  RTT min:              0.000980 sec</span><br><span class="line">  RTT average:          0.005502 sec</span><br><span class="line">  RTT std deviation:    0.001641 sec</span><br><span class="line">  RTT out of range:     0 queries</span><br><span class="line">  </span><br><span class="line">  Percentage completed: 100.00%</span><br><span class="line">  Percentage lost:        0.00%</span><br><span class="line">  </span><br><span class="line">  Started at:           Thu Sep 22 15:01:28 2022</span><br><span class="line">  Finished at:          Thu Sep 22 15:03:13 2022</span><br><span class="line">  Ran for:              104.918484 seconds</span><br><span class="line">  </span><br><span class="line">  Queries per second:   476.560450 qps</span><br></pre></td></tr></table></figure>
<h4 id="测试总结："><a href="#测试总结：" class="headerlink" title="测试总结："></a>测试总结：</h4><p>经过以上的单元测试和压力测试，新版本的nacos-coredns-plugin插件，在新增的与nacos服务端建立gRPC长连接的功能支持下，插件表现稳定，且DNS请求的 qps 从 209 提升到 467， 得到了接近 223% 的性能增长。</p>
<h3 id="项目完成质量："><a href="#项目完成质量：" class="headerlink" title="项目完成质量："></a>项目完成质量：</h3><p><strong>1． 技术方案评价</strong><br>本次项目致力于让Nacos-CoreDNS模块支持以gRPC长连接方式访问Nacos服务端，具有一定的难度。但是在经过导师指导和讨论后，逐步完成了方案的优化，使得方案的设计更有可靠性和完善性。由于前期技术方案进行了比较严格的分析和策划，所以相对后期的实现而言，改动较少，提高了开发效率；<br><strong>2．项目质量评价</strong><br>经过比较严密的稳定性测试和压力测试，整个插件表现稳定，可以很好的完成题目给的需求。本项目模块化独立开发，与其他模块耦合度小，较为容易进行维护。此插件使用golang语言编写，具有良好的跨平台可移植性。此外，开发进度也能够按照前期的时间规划进行，按时提交了项目产出。</p>
<h3 id="与导师沟通及反馈情况："><a href="#与导师沟通及反馈情况：" class="headerlink" title="与导师沟通及反馈情况："></a>与导师沟通及反馈情况：</h3><p>由于对这个项目比较感兴趣，所以在项目公布早期就与导师进行了沟通联系。在与导师沟通的过程中，得到了许多有用的反馈，帮助我了解了整个项目的详情细节。同时导师也给我了许多建议来对方案进行优化改进。可以说，整个过程中，与指导老师的沟通情况非常的默契。当我遇到困难和问题的时候，指导老师可以主动地为我解决问题，而且还会为我提出更好的建议。我所提出合理的意见，老师也会采取。</p>
<h3 id="我的收获"><a href="#我的收获" class="headerlink" title="我的收获"></a>我的收获</h3><p>虽然此次项目时间只有三个月，在这期间不一定会让一个人有着翻天覆地的变化，但变化就是这样一点一点产生的，同时也感觉有很大的收获，也帮助找出了自己的不足和需要改进的地方。在遇到问题虚心请教后，从导师的身上能学到自己没有的东西，每一次都会使我更接近成功。还有学会了在开发中与人的合作与交流。<br>在这个项目之前，我对待开发方案和文档这些东西会不太注重，写得比较粗略。但是通过这个项目，我体会到有效详细的方案设计和开发文档，可以很大的提高开发效率，保证项目的可行性和可维护性。<br>代码风格要规范，之前写代码，我都是不怎么去注意代码风格和写代码的规范，都是稍微想一下就直接开始写代码了。注释也很少用，总感觉我们自己写的代码，我们怎么会不知道它做了些什么事呢 ？总觉得我们自己写的代码我们怎么会不知道它是用来做什么的呢。但通过这次项目，我体会到保持规范统一的代码风格的重要性，可以保证代码的可读性，让别人更容易理解自己写的代码。<br>我也借助到这个机会，可以参与开源项目中，积累了相关经验、学习到新的知识。为日后继续参与更多开源项目提供一个经验借鉴。此外我对Nacos非常感兴趣，希望项目结束后也能在Nacos其他方面做一点点贡献。  </p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/24/bit-compute/" rel="prev" title="位运算符">
      <i class="fa fa-chevron-left"></i> 位运算符
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/15/coredns-test-report/" rel="next" title="ospp记录(四) 项目测试文档">
      ospp记录(四) 项目测试文档 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E3%80%90%E7%BB%93%E9%A2%98%E6%8A%A5%E5%91%8A%E3%80%91Nacos-CoreDNS%E6%A8%A1%E5%9D%97%E6%94%AF%E6%8C%81%E4%BB%A5%E9%95%BF%E8%BF%9E%E6%8E%A5%E8%AE%BF%E9%97%AENacos%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">1.</span> <span class="nav-text">【结题报告】Nacos-CoreDNS模块支持以长连接访问Nacos服务端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%BF%A1%E6%81%AF"><span class="nav-number">1.2.</span> <span class="nav-text">项目信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%90%8D%E7%A7%B0%EF%BC%9ANacos-CoreDNS%E6%A8%A1%E5%9D%97%E6%94%AF%E6%8C%81%E4%BB%A5%E9%95%BF%E8%BF%9E%E6%8E%A5%E8%AE%BF%E9%97%AENacos%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">1.2.1.</span> <span class="nav-text">项目名称：Nacos-CoreDNS模块支持以长连接访问Nacos服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%BA%A7%E5%87%BA%EF%BC%9A"><span class="nav-number">1.2.2.</span> <span class="nav-text">项目产出：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E6%8F%8F%E8%BF%B0%EF%BC%9A"><span class="nav-number">1.2.3.</span> <span class="nav-text">方案描述：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">核心方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">grpc通信流程设计</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%EF%BC%9A"><span class="nav-number">1.2.4.</span> <span class="nav-text">方案具体实现：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E3%80%81-%E6%9E%84%E5%BB%BA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">一、 构建客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E3%80%81-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">二、 客户端的主要功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E6%8F%92%E4%BB%B6%E7%9A%84%E8%B5%84%E6%BA%90%E9%9C%80%E6%B1%82%EF%BC%8C%E5%B0%81%E8%A3%85sdk%E6%96%B9%E6%B3%95%EF%BC%8C-%E5%AE%8C%E6%88%90%E9%80%9A%E4%BF%A1%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2%E3%80%82"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">根据插件的资源需求，封装sdk方法， 完成通信中的数据交换。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E3%80%81-%E6%9B%BF%E6%8D%A2%E5%8E%9F%E6%9D%A5%E6%8F%92%E4%BB%B6%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">三、 替换原来插件的数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E8%A7%84%E5%88%92"><span class="nav-number">1.2.5.</span> <span class="nav-text">时间规划</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93"><span class="nav-number">1.3.</span> <span class="nav-text">项目总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="nav-number">1.3.1.</span> <span class="nav-text">遇到的问题及解决方案：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-nacos%E6%97%A7%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC%E5%90%8E%EF%BC%8C%E5%8E%9F%E6%9D%A5%E7%9A%84API%E8%A2%AB%E7%A7%BB%E9%99%A4%E4%BA%86%E3%80%82"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">1. nacos旧版本升级到新版本后，原来的API被移除了。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">2. 数据缓存问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">3. 数据更新问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E7%BC%96%E8%AF%91%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">4. 编译问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="nav-number">1.3.2.</span> <span class="nav-text">项目测试：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">测试用例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">压力测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">测试总结：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%8C%E6%88%90%E8%B4%A8%E9%87%8F%EF%BC%9A"><span class="nav-number">1.3.3.</span> <span class="nav-text">项目完成质量：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%AF%BC%E5%B8%88%E6%B2%9F%E9%80%9A%E5%8F%8A%E5%8F%8D%E9%A6%88%E6%83%85%E5%86%B5%EF%BC%9A"><span class="nav-number">1.3.4.</span> <span class="nav-text">与导师沟通及反馈情况：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%91%E7%9A%84%E6%94%B6%E8%8E%B7"><span class="nav-number">1.3.5.</span> <span class="nav-text">我的收获</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">SoarYu</p>
  <div class="site-description" itemprop="description">Done is better than perfect!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SoarYu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
