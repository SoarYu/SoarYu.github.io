<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.soar2568.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="基于kubernetes V1.25版本。从V1.24开始，kubernetes默认容器运行时使用containerd，不再使用docker。">
<meta property="og:type" content="article">
<meta property="og:title" content="K8S 集群部署学习记录">
<meta property="og:url" content="http://blog.soar2568.top/2023/01/06/K3S-learning/index.html">
<meta property="og:site_name" content="Soar2568">
<meta property="og:description" content="基于kubernetes V1.25版本。从V1.24开始，kubernetes默认容器运行时使用containerd，不再使用docker。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/28915315/1664114191862-6dfeb893-b80d-4d71-b2a1-6862b68b22b1.png#averageHue=%23071a1f&clientId=uca5f7f44-ddce-4&errorMessage=unknown%20error&from=paste&height=560&id=ued1f7420&name=image.png&originHeight=1120&originWidth=1740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=164307&status=error&style=none&taskId=ueaed5979-f365-4f38-9f24-3688965f700&title=&width=870">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/28915315/1663814727899-c31f2117-d540-48fc-93dc-e004dbf1abfb.png#averageHue=%230c1e24&clientId=u8b252c4c-2ccb-4&errorMessage=unknown%20error&from=paste&height=68&id=u1c6f8676&name=image.png&originHeight=136&originWidth=1744&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25497&status=error&style=none&taskId=ue22858f7-27a3-4ce9-b8a5-b11163e70ae&title=&width=872">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/28915315/1664261419003-e9a5a68a-f988-48da-a51d-b8756bce8f24.png#averageHue=%23f7f6f5&from=url&id=md9bG&originHeight=762&originWidth=1306&originalType=binary&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/28915315/1663905517618-074351d1-bdc4-4a33-b9de-55d8bfa4c95b.png?x-oss-process=image/resize,w_589,limit_0#averageHue=%23f7f7f7&from=url&id=WjUyO&originHeight=390&originWidth=589&originalType=binary&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/28915315/1665656300936-3dff684a-d5da-4165-b70f-a28f183b57f6.png?x-oss-process=image/resize,w_607,limit_0#averageHue=%23fbfcf7&from=url&id=gABjk&originHeight=376&originWidth=607&originalType=binary&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="article:published_time" content="2023-01-06T13:32:43.000Z">
<meta property="article:modified_time" content="2023-07-04T08:09:47.312Z">
<meta property="article:author" content="SoarYu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2022/png/28915315/1664114191862-6dfeb893-b80d-4d71-b2a1-6862b68b22b1.png#averageHue=%23071a1f&clientId=uca5f7f44-ddce-4&errorMessage=unknown%20error&from=paste&height=560&id=ued1f7420&name=image.png&originHeight=1120&originWidth=1740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=164307&status=error&style=none&taskId=ueaed5979-f365-4f38-9f24-3688965f700&title=&width=870">

<link rel="canonical" href="http://blog.soar2568.top/2023/01/06/K3S-learning/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>K8S 集群部署学习记录 | Soar2568</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Soar2568</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.soar2568.top/2023/01/06/K3S-learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SoarYu">
      <meta itemprop="description" content="Done is better than perfect!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Soar2568">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8S 集群部署学习记录
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-06 13:32:43" itemprop="dateCreated datePublished" datetime="2023-01-06T13:32:43+00:00">2023-01-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-07-04 08:09:47" itemprop="dateModified" datetime="2023-07-04T08:09:47+00:00">2023-07-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          
            <div class="post-description">基于kubernetes V1.25版本。从V1.24开始，kubernetes默认容器运行时使用containerd，不再使用docker。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="一、K3S-集群部署"><a href="#一、K3S-集群部署" class="headerlink" title="一、K3S 集群部署"></a>一、K3S 集群部署</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  关闭防火墙</span></span><br><span class="line"><span class="comment">#  设置selinux(需要联网)</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld --now</span><br><span class="line">yum install -y container-selinux selinux-policy-base</span><br><span class="line">yum install -y https://rpm.rancher.io/k3s/latest/common/centos/7/noarch/k3s-selinux-0.2-1.el7_8.noarch.rpm</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将k3s二进制文件移动到/usr/local/bin目录，并添加执行权限</span></span><br><span class="line"><span class="built_in">mv</span> k3s /usr/local/bin</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/k3s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将镜像移动到/var/lib/rancher/k3s/agent/images/目录（无需解压）</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /var/lib/rancher/k3s/agent/images/</span><br><span class="line"><span class="built_in">cp</span> ./k3s-airgap-images-amd64.tar.gz /var/lib/rancher/k3s/agent/images/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在k8s-master节点执行：</span></span><br><span class="line"><span class="comment">#修改权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x install.sh</span><br><span class="line"><span class="comment">#离线安装</span></span><br><span class="line">INSTALL_K3S_SKIP_DOWNLOAD=<span class="literal">true</span> ./install.sh</span><br><span class="line"><span class="comment">#安装完成后，查看节点状态</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment">#查看token</span></span><br><span class="line"><span class="built_in">cat</span> /var/lib/rancher/k3s/server/node-token</span><br><span class="line"><span class="comment">#K103b3dfdad0ab6fe42a55a30b7873ac52baecbd27189fe27673b4c08358ef26231::server:de73b527ff36592ac954c7bed67215e0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#K103b3dfdad0ab6fe42a55a30b7873ac52baecbd27189fe27673b4c08358ef26231::server:de73b527ff36592ac954c7bed67215e0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在k8s-worker1和k8s-worker2节点执行</span></span><br><span class="line">INSTALL_K3S_SKIP_DOWNLOAD=<span class="literal">true</span> \</span><br><span class="line">K3S_URL=https://192.168.66.52:6443 \</span><br><span class="line">K3S_TOKEN=K103b3dfdad0ab6fe42a55a30b7873ac52baecbd27189fe27673b4c08358ef26231::server:de73b527ff36592ac954c7bed67215e0 \</span><br><span class="line">./install.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><ul>
<li>最低运行要求<ul>
<li>内存: 512MB   &#x2F;   CPU: 1 核心</li>
</ul>
</li>
<li>K3s版本：<strong>v1.25.0+k3s1</strong></li>
<li>集群规划<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>配置</th>
<th>系统</th>
<th>网络</th>
</tr>
</thead>
<tbody><tr>
<td>k8s - master</td>
<td>192.168.66.52</td>
<td>内存：4G</td>
<td></td>
<td></td>
</tr>
<tr>
<td>CPU：4核(8逻辑核心)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>硬盘：20G</td>
<td>ubuntu20.04</td>
<td>vmware</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bridge模式</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>k8s-worker1</td>
<td>192.168.66.53</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>k8s-worker2</td>
<td>192.168.66.54</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h2><p>需要在每台机器上执行如下命令：</p>
<ul>
<li>关闭防火墙</li>
<li>设置selinux(需要联网): 安全增强型 Linux（Security-Enhanced Linux）简称 SELinux，它是一个 Linux 内核模块，也是 Linux 的一个安全子系统。SELinux 主要作用就是最大限度地减小系统中服务进程可访问的资源（最小权限原则）。<a target="_blank" rel="noopener" href="https://www.cnblogs.com/call-me-dasheng/p/15888546.html">https://www.cnblogs.com/call-me-dasheng/p/15888546.html</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw <span class="built_in">disable</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y container-selinux selinux-policy-base</span><br><span class="line">yum install -y https://rpm.rancher.io/k3s/latest/common/centos/7/noarch/k3s-selinux-0.2-1.el7_8.noarch.rpm</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2-下载安装包"><a href="#2-下载安装包" class="headerlink" title="2.下载安装包"></a>2.下载安装包</h2><p>下载安装脚本<code>**install.sh**</code>：<a target="_blank" rel="noopener" href="https://get.k3s.io/">https://get.k3s.io/</a><br>下载<code>**k3s**</code>二进制文件：<a target="_blank" rel="noopener" href="https://github.com/k3s-io/k3s/releases/download/v1.25.0%2Bk3s1/k3s">k3s</a><br>下载必要的<strong>image</strong>：<a target="_blank" rel="noopener" href="https://github.com/k3s-io/k3s/releases/download/v1.25.0%2Bk3s1/k3s-airgap-images-amd64.tar.gz">离线安装需要的image文件</a></p>
<blockquote>
<p>这些文件都可以在github仓库中获取：<a target="_blank" rel="noopener" href="https://github.com/k3s-io/k3s">https://github.com/k3s-io/k3s</a></p>
</blockquote>
<h2 id="3-执行安装脚本"><a href="#3-执行安装脚本" class="headerlink" title="3.执行安装脚本"></a>3.执行安装脚本</h2><ol>
<li><p>将k3s二进制文件移动到&#x2F;usr&#x2F;local&#x2F;bin目录，并添加执行权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> k3s /usr/local/bin</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/k3s</span><br></pre></td></tr></table></figure>
</li>
<li><p>将镜像移动到&#x2F;var&#x2F;lib&#x2F;rancher&#x2F;k3s&#x2F;agent&#x2F;images&#x2F;目录（无需解压）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /var/lib/rancher/k3s/agent/images/</span><br><span class="line"><span class="built_in">cp</span> ./k3s-airgap-images-amd64.tar.gz /var/lib/rancher/k3s/agent/images/</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li><p>在k8s-master节点执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x install.sh</span><br><span class="line"><span class="comment">#离线安装</span></span><br><span class="line">INSTALL_K3S_SKIP_DOWNLOAD=<span class="literal">true</span> ./install.sh</span><br><span class="line"><span class="comment">#安装完成后，查看节点状态</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment">#查看token</span></span><br><span class="line"><span class="built_in">cat</span> /var/lib/rancher/k3s/server/node-token</span><br><span class="line"><span class="comment">#K106e06c1493d4fc3b4941c85d6dbfdaf7140a7e660ca8b6f849f89ff480c4ed418::server:5af23e94c7de63baa6372e9c1ba58e3c</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在k8s-worker1和k8s-worker2节点执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALL_K3S_SKIP_DOWNLOAD=<span class="literal">true</span> \</span><br><span class="line">K3S_URL=https://192.168.66.52:6443 \</span><br><span class="line">K3S_TOKEN=K106e06c1493d4fc3b4941c85d6dbfdaf7140a7e660ca8b6f849f89ff480c4ed418::server:5af23e94c7de63baa6372e9c1ba58e3c \</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="虚拟网卡-cni0"><a href="#虚拟网卡-cni0" class="headerlink" title="虚拟网卡 cni0"></a>虚拟网卡 cni0</h2><p>k8s内部的虚拟网络：<br>master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cni0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 10.42.0.1  netmask 255.255.255.0  broadcast 10.42.0.255</span><br><span class="line">        inet6 fe80::2482:52ff:fec9:2e8c  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 26:82:52:c9:2e:8c  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 157038  bytes 33121066 (31.5 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 188136  bytes 33822037 (32.2 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>slave1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cni0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 10.42.1.1  netmask 255.255.255.0  broadcast 10.42.1.255</span><br><span class="line">        inet6 fe80::b89d:9cff:fefd:13fe  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether ba:9d:9c:fd:13:fe  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 7  bytes 472 (472.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 986  bytes 174561 (170.4 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>slave2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cni0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 10.42.2.1  netmask 255.255.255.0  broadcast 10.42.2.255</span><br><span class="line">        inet6 fe80::44e5:b5ff:fe98:cc35  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 46:e5:b5:98:cc:35  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 35  bytes 3770 (3.6 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 4067  bytes 1530154 (1.4 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<h2 id="排查错误"><a href="#排查错误" class="headerlink" title="排查错误"></a>排查错误</h2><p>如果安装或启动不成功，可能有以下几个原因：</p>
<ol>
<li>时间不统一</li>
<li>IP有冲突，请为每个主机分配不同的IP</li>
<li>主机名(hostname)重复，请为每个主机设置不同的主机名</li>
<li>网卡的MAC有冲突，复制虚拟机时，请为所有网卡重新生产MAC地址</li>
</ol>
<p>参考文档：<br><a target="_blank" rel="noopener" href="https://k3s.io/">https://k3s.io/</a><br><a target="_blank" rel="noopener" href="https://rancher.com/docs/k3s/latest/en/">https://rancher.com/docs/k3s/latest/en/</a><br><a target="_blank" rel="noopener" href="https://rancher.com/docs/k3s/latest/en/quick-start/">https://rancher.com/docs/k3s/latest/en/quick-start/</a><br><a target="_blank" rel="noopener" href="https://rancher.com/docs/k3s/latest/en/installation/airgap/">https://rancher.com/docs/k3s/latest/en/installation/airgap/</a></p>
<h1 id="二、镜像加速"><a href="#二、镜像加速" class="headerlink" title="二、镜像加速"></a>二、镜像加速</h1><p>由于kubernetes从<code>V1.24</code>版本开始默认使用<code>**containerd**</code>作为容器服务，需要修改<code>**containerd**</code>的配置文件，才能让Pod的镜像使用镜像加速器。<br>配置文件路径一般为<code>**/etc/containerd/config.toml**</code>，详见<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/60750.html">阿里云镜像加速</a>。</p>
<h2 id="在K3s中配置镜像仓库"><a href="#在K3s中配置镜像仓库" class="headerlink" title="在K3s中配置镜像仓库"></a>在K3s中配置镜像仓库</h2><p>K3s 会自动生成containerd的配置文件**&#x2F;var&#x2F;lib&#x2F;rancher&#x2F;k3s&#x2F;agent&#x2F;etc&#x2F;containerd&#x2F;config.toml**,不要直接修改这个文件，k3s重启后修改会丢失。<br>为了简化配置，K3s 通过**&#x2F;etc&#x2F;rancher&#x2F;k3s&#x2F;registries.yaml**文件来配置镜像仓库，K3s会在启动时检查这个文件是否存在。<br>我们需要在每个节点上新建&#x2F;etc&#x2F;rancher&#x2F;k3s&#x2F;registries.yaml文件，配置内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mirrors:</span></span><br><span class="line">  <span class="attr">docker.io:</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://fsp2sfpr.mirror.aliyuncs.com/&quot;</span></span><br></pre></td></tr></table></figure>
<p>重启每个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart k3s</span><br><span class="line">systemctl restart k3s-agent</span><br></pre></td></tr></table></figure>
<p>查看配置是否生效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/lib/rancher/k3s/agent/etc/containerd/config.toml</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/28915315/1664114191862-6dfeb893-b80d-4d71-b2a1-6862b68b22b1.png#averageHue=%23071a1f&clientId=uca5f7f44-ddce-4&errorMessage=unknown%20error&from=paste&height=560&id=ued1f7420&name=image.png&originHeight=1120&originWidth=1740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=164307&status=error&style=none&taskId=ueaed5979-f365-4f38-9f24-3688965f700&title=&width=870" alt="image.png"></p>
<h1 id="三、创建和管理Pod"><a href="#三、创建和管理Pod" class="headerlink" title="三、创建和管理Pod"></a>三、创建和管理Pod</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个pod：mynginx, 使用镜像nginx</span></span><br><span class="line">kubectl run mynginx --image=nginx:1.22</span><br><span class="line"><span class="comment"># 查看Pod</span></span><br><span class="line">kubectl get pod</span><br><span class="line"><span class="comment"># 描述</span></span><br><span class="line">kubectl describe pod mynginx</span><br><span class="line"><span class="comment"># 查看Pod的运行日志</span></span><br><span class="line">kubectl logs mynginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示pod的IP和运行节点信息</span></span><br><span class="line">kubectl get pod -owide</span><br><span class="line"><span class="comment"># 使用Pod的ip+pod里面运行容器的端口</span></span><br><span class="line">curl 10.42.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入内部，在容器中执行bash</span></span><br><span class="line">kubectl <span class="built_in">exec</span> mynginx -it -- /bin/bash</span><br><span class="line"></span><br><span class="line">kubectl get po --watch</span><br><span class="line"><span class="comment"># -it 交互模式 </span></span><br><span class="line"><span class="comment"># --rm 退出后删除容器，多用于执行一次性任务或使用客户端</span></span><br><span class="line">kubectl run mynginx --image=nginx -it --<span class="built_in">rm</span> -- /bin/bash </span><br><span class="line">kubectl run my-busybox --image=busybox -it --<span class="built_in">rm</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">kubectl delete pod mynginx</span><br><span class="line"><span class="comment"># 强制删除</span></span><br><span class="line">kubectl delete pod mynginx --force</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2022/png/28915315/1663814727899-c31f2117-d540-48fc-93dc-e004dbf1abfb.png#averageHue=%230c1e24&clientId=u8b252c4c-2ccb-4&errorMessage=unknown%20error&from=paste&height=68&id=u1c6f8676&name=image.png&originHeight=136&originWidth=1744&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25497&status=error&style=none&taskId=ue22858f7-27a3-4ce9-b8a5-b11163e70ae&title=&width=872" alt="image.png"></p>
<h2 id="创建管理Deployment-部署-与ReplicaSet-副本集"><a href="#创建管理Deployment-部署-与ReplicaSet-副本集" class="headerlink" title="创建管理Deployment(部署)与ReplicaSet(副本集)"></a>创建管理Deployment(部署)与ReplicaSet(副本集)</h2><p><strong>Deployment</strong>是对ReplicaSet和Pod更高级的抽象。<br>它使Pod拥有多副本，自愈，扩缩容、滚动升级等能力。</p>
<p><strong>ReplicaSet</strong>(副本集)是一个Pod的集合。<br>它可以设置运行Pod的数量，确保任何时间都有指定数量的 Pod 副本在运行。<br>通常我们不直接使用ReplicaSet，而是在Deployment中声明。</p>
<h2 id="创建deployment和replicaset"><a href="#创建deployment和replicaset" class="headerlink" title="创建deployment和replicaset"></a>创建deployment和replicaset</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建deployment,部署3个运行nginx的Pod</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl create deployment nginx-deploy --image=nginx:1.22 --replicas=3</span></span><br><span class="line">deployment.apps/nginx-deploy created</span><br><span class="line"></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME                            READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginx-deploy-855866bb46-xnqzf   0/1     ContainerCreating   0          29s</span><br><span class="line">nginx-deploy-855866bb46-clg2r   0/1     ContainerCreating   0          29s</span><br><span class="line">nginx-deploy-855866bb46-s2zqc   1/1     Running             0          29s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看deployment</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get deploy</span></span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   3/3     3            3           3m6s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看replicaSet</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get replicaset</span></span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-855866bb46   3         3         3       3m17s</span><br></pre></td></tr></table></figure>

<h2 id="Pod自愈功能"><a href="#Pod自愈功能" class="headerlink" title="Pod自愈功能"></a>Pod自愈功能</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除其中一个pod</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl delete pod nginx-deploy-855866bb46-s2zqc</span></span><br><span class="line">pod <span class="string">&quot;nginx-deploy-855866bb46-s2zqc&quot;</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 很快补全副本集里的pod，实现自愈功能</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deploy-855866bb46-xnqzf   1/1     Running   0          5m59s</span><br><span class="line">nginx-deploy-855866bb46-clg2r   1/1     Running   0          5m59s</span><br><span class="line">nginx-deploy-855866bb46-8rdbn   1/1     Running   0          118s</span><br></pre></td></tr></table></figure>

<h2 id="Pod缩放功能"><a href="#Pod缩放功能" class="headerlink" title="Pod缩放功能"></a>Pod缩放功能</h2><ul>
<li><p>手动缩放</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将副本数量调整为5</span></span><br><span class="line">kubectl scale deployment/nginx-deployment --replicas=5</span><br><span class="line">kubectl get deploy</span><br><span class="line"></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get replicaset --watch</span></span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-855866bb46   5         5         5       23m</span><br><span class="line">nginx-deploy-855866bb46   3         5         5       23m</span><br><span class="line">nginx-deploy-855866bb46   3         5         5       23m</span><br><span class="line">nginx-deploy-855866bb46   3         3         3       23m</span><br><span class="line">nginx-deploy-855866bb46   5         3         3       23m</span><br></pre></td></tr></table></figure>
</li>
<li><p>自动缩放</p>
</li>
</ul>
<p>自动缩放通过增加和减少副本的数量，以保持所有 Pod 的平均 CPU 利用率不超过 75%。<br>自动伸缩需要声明Pod的资源限制，同时使用 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/metrics-server#readme">Metrics Server</a> 服务（K3s默认已安装）。</p>
<blockquote>
<p>本例仅用来说明<code>kubectl autoscale</code>命令的使用，完整示例参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">HPA演示</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自动缩放</span></span><br><span class="line">kubectl autoscale deployment/nginx-auto --min=3 --max=10 --cpu-percent=75 </span><br><span class="line"><span class="comment">#查看自动缩放</span></span><br><span class="line">kubectl get hpa</span><br><span class="line"><span class="comment">#删除自动缩放</span></span><br><span class="line">kubectl delete hpa nginx-deployment</span><br></pre></td></tr></table></figure>

<h2 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看版本和Pod</span></span><br><span class="line">kubectl get deployment/nginx-deployment -owide</span><br><span class="line">kubectl get pods</span><br><span class="line"></span><br><span class="line"><span class="comment">#更新容器镜像</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment/nginx-deployment nginx=nginx:1.23</span><br><span class="line"><span class="comment">#滚动更新</span></span><br><span class="line">kubectl rollout status deployment/nginx-deployment</span><br><span class="line"><span class="comment">#查看过程</span></span><br><span class="line">kubectl get rs --watch</span><br></pre></td></tr></table></figure>
<h2 id="版本回滚"><a href="#版本回滚" class="headerlink" title="版本回滚"></a>版本回滚</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看历史版本</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-deployment</span><br><span class="line"><span class="comment">#查看指定版本的信息</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-deployment --revision=2</span><br><span class="line"><span class="comment">#回滚到历史版本</span></span><br><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=2</span><br></pre></td></tr></table></figure>

<h1 id="四、Service-服务"><a href="#四、Service-服务" class="headerlink" title="四、Service 服务"></a>四、Service 服务</h1><ul>
<li>Service将运行在一组 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/">Pods</a> 上的应用程序公开为网络服务的抽象方法。</li>
<li>Service为一组 Pod 提供相同的 DNS 域名，并且在它们之间进行负载均衡。</li>
<li>服务发现：Kubernetes 为 Pod 提供分配了IP 地址，但IP地址可能会发生变化。集群内的容器可以通过service名称访问服务，而不需要担心Pod的IP发生变化。</li>
</ul>
<p>Kubernetes Service 定义了这样一种抽象：<br>逻辑上的一组可以互相替换的 Pod，通常称为微服务。<br>Service 对应的 Pod集合 通常是通过<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/">选择算符</a>来确定的。<br>举个例子，在一个Service中运行了3个nginx的副本。这些副本是可互换的，我们不需要关心它们调用了哪个nginx，也不需要关注 Pod的运行状态，只需要调用这个服务就可以了。</p>
<h3 id="创建与访问Service对象"><a href="#创建与访问Service对象" class="headerlink" title="创建与访问Service对象"></a>创建与访问Service对象</h3><p><strong>创建Service时根据type取值不同，服务暴露的方式和范围不同</strong><br>●ClusterIP：将服务公开在集群内部。kubernetes会给服务分配一个集群内部的 IP，集群内的所有主机都可以通过这个Cluster-IP访问服务。集群内部的Pod可以通过service名称访问服务。<br>●<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#type-nodeport">NodePort</a>：通过每个节点的主机IP 和静态端口（NodePort）暴露服务。 集群的外部主机可以使用节点IP和NodePort访问服务。<br>●<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#externalname">ExternalName</a>：将集群外部的网络引入集群内部。<br>●<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#loadbalancer">LoadBalancer</a>：使用云提供商的负载均衡器向外部暴露服务。 </p>
<p><strong>ClusterIP</strong><br>集群内的所有主机都可以通过这个Cluster-IP访问服务。集群内部的Pod可以通过service名称访问服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建服务， 指定deploy为作为提供服务的抽象，port为pod端口，</span></span><br><span class="line">kubectl expose deploy/nginx-deploy --name=nginx-service --port=8080 --target-port=80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群内访问服务</span></span><br><span class="line">kubectl get service</span><br><span class="line">curl 10.43.13.226:8080</span><br><span class="line"></span><br><span class="line"><span class="comment">#容器内访问</span></span><br><span class="line">kubectl run nginx-test --image=nginx:1.22 -it --<span class="built_in">rm</span> -- sh</span><br><span class="line">curl nginx-service:8080</span><br></pre></td></tr></table></figure>

<p><strong>NodePort</strong><br>每个节点的主机IP 和静态端口（NodePort）暴露服务。 集群的外部主机可以使用节点IP和NodePort访问服务。<br>1.NodePort端口是随机的，范围为:30000-32767。<br>2.集群中每一个主机节点的NodePort端口都可以访问。<br>3.如果需要指定端口，不想随机产生，需要使用配置文件来声明。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/28915315/1664261419003-e9a5a68a-f988-48da-a51d-b8756bce8f24.png#averageHue=%23f7f6f5&from=url&id=md9bG&originHeight=762&originWidth=1306&originalType=binary&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>**命名空间(Namespace)**是一种资源隔离机制，将同一集群中的资源划分为相互隔离的组。<br>命名空间可以在多个用户之间划分集群资源（通过<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/policy/resource-quotas/">资源配额</a>）。</p>
<ul>
<li>例如我们可以设置<strong>开发、测试、生产</strong>等多个命名空间。</li>
</ul>
<p>同一命名空间内的资源名称要唯一，但跨命名空间时没有这个要求。<br>命名空间作用域仅针对带有名字空间的对象，例如 Deployment、Service 等。<br>这种作用域对集群访问的对象不适用，例如 StorageClass、Node、PersistentVolume 等。</p>
<hr>
<p><strong>Kubernetes 会创建四个初始命名空间：</strong></p>
<ul>
<li><code>**default**</code> 默认的命名空间，不可删除，未指定命名空间的对象都会被分配到default中。</li>
<li><code>**kube-system**</code> Kubernetes 系统对象(控制平面和Node组件)所使用的命名空间。</li>
<li><code>**kube-public**</code>** **自动创建的公共命名空间，所有用户（包括未经过身份验证的用户）都可以读取它。通常我们约定，将整个集群中公用的可见和可读的资源放在这个空间中。 </li>
<li><code>**kube-node-lease**</code>** ** <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubernetes-api/cluster-resources/lease-v1/">租约（Lease）</a>对象使用的命名空间。每个节点都有一个关联的 lease 对象，lease 是一种轻量级资源。lease对象通过发送<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/#heartbeats">心跳</a>，检测集群中的每个节点是否发生故障。<blockquote>
<p>使用<code>kubectl get lease -A</code>查看<code>lease</code>对象</p>
</blockquote>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取所有namespace的所有Pod</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE     NAME                                      READY   STATUS      RESTARTS        AGE</span><br><span class="line">kube-system   helm-install-traefik-crd-bmc95            0/1     Completed   0               2d5h</span><br><span class="line">kube-system   helm-install-traefik-ch646                0/1     Completed   1               2d5h</span><br><span class="line">kube-system   svclb-traefik-145ced16-7zgm8              2/2     Running     4 (9h ago)      2d5h</span><br><span class="line">kube-system   svclb-traefik-145ced16-vsrzd              2/2     Running     2 (9h ago)      2d5h</span><br><span class="line">kube-system   local-path-provisioner-5b5579c644-q4rz5   1/1     Running     4 (9h ago)      2d5h</span><br><span class="line">kube-system   metrics-server-74474969b-lf98p            1/1     Running     4 (9h ago)      2d5h</span><br><span class="line">kube-system   coredns-75fc8f8fff-t8ktq                  1/1     Running     2 (9h ago)      2d5h</span><br><span class="line">kube-system   traefik-7d647b7597-j5dnm                  1/1     Running     2 (9h ago)      2d5h</span><br><span class="line">kube-system   svclb-traefik-145ced16-ttrph              2/2     Running     4 (6h28m ago)   2d5h</span><br><span class="line">default       nginx-deploy-855866bb46-clg2r             1/1     Running     0               5h4m</span><br><span class="line">default       nginx-deploy-855866bb46-8rdbn             1/1     Running     0               5h</span><br><span class="line">default       nginx-deploy-855866bb46-qwtvj             1/1     Running     0               4h34m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看lease空间内的所有对象</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get lease -A</span></span><br><span class="line">NAMESPACE         NAME           HOLDER         AGE</span><br><span class="line">kube-node-lease   k3s-slave54    k3s-slave54    2d5h</span><br><span class="line">kube-node-lease   k3s-master52   k3s-master52   2d5h</span><br><span class="line">kube-node-lease   k3s-slave53    k3s-slave53    2d5h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个新的ns: develop</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl create ns develop</span></span><br><span class="line">namespace/develop created</span><br><span class="line"><span class="comment"># 创建一个pod,指定pod的ns</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl run nginx --image=nginx:1.22 -n=develop</span></span><br><span class="line">pod/nginx created</span><br><span class="line"></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get pod -n=develop</span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          20s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改develop为default的ns</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl config set-context $(kubectl config current-context) --namespace=develop</span></span><br><span class="line">Context <span class="string">&quot;default&quot;</span> modified.</span><br><span class="line"></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          75s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除ns，释放ns内的所有资源，如果资源无法释放，删除失败</span></span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl delete ns develop</span></span><br><span class="line">namespace <span class="string">&quot;develop&quot;</span> deleted</span><br><span class="line">[root@k3s-master52 ~]<span class="comment"># kubectl get ns</span></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   2d5h</span><br><span class="line">kube-system       Active   2d5h</span><br><span class="line">kube-public       Active   2d5h</span><br><span class="line">kube-node-lease   Active   2d5h</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="五、Namespace命名空间"><a href="#五、Namespace命名空间" class="headerlink" title="五、Namespace命名空间"></a>五、Namespace命名空间</h1><h2 id="使用多个命名空间"><a href="#使用多个命名空间" class="headerlink" title="使用多个命名空间"></a>使用多个命名空间</h2><ul>
<li>命名空间是在多个用户之间划分集群资源的一种方法（通过<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/policy/resource-quotas/">资源配额</a>）。<ul>
<li>例如我们可以设置<strong>开发、测试、生产</strong>等多个命名空间。</li>
</ul>
</li>
<li>不必使用多个命名空间来分隔轻微不同的资源。<ul>
<li>例如同一软件的不同版本： 应该使用<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/">标签</a> 来区分同一命名空间中的不同资源。</li>
</ul>
</li>
<li>命名空间适用于跨多个团队或项目的场景。<ul>
<li>对于只有几到几十个用户的集群，可以不用创建命名空间。</li>
</ul>
</li>
<li>命名空间不能相互嵌套，每个 Kubernetes 资源只能在一个命名空间中。</li>
</ul>
<h2 id="管理命名空间"><a href="#管理命名空间" class="headerlink" title="管理命名空间"></a>管理命名空间</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建命名空间</span></span><br><span class="line">kubectl create namespace dev</span><br><span class="line"><span class="comment">#查看命名空间</span></span><br><span class="line">kubectl get ns</span><br><span class="line"></span><br><span class="line"><span class="comment">#在命名空间内运行Pod</span></span><br><span class="line">kubectl run nginx --image=nginx --namespace=dev</span><br><span class="line">kubectl run my-nginx --image=nginx -n=dev</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看命名空间内的Pod</span></span><br><span class="line">kubectl get pods -n=dev</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看命名空间内所有对象</span></span><br><span class="line">kubectl get all</span><br><span class="line"><span class="comment"># 删除命名空间会删除命名空间下的所有内容</span></span><br><span class="line">kubectl delete ns dev</span><br></pre></td></tr></table></figure>
<h2 id="切换当前命名空间"><a href="#切换当前命名空间" class="headerlink" title="切换当前命名空间"></a>切换当前命名空间</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前上下文</span></span><br><span class="line">kubectl config current-context</span><br><span class="line"></span><br><span class="line"><span class="comment">#将dev设为当前命名空间，后续所有操作都在此命名空间下执行。</span></span><br><span class="line">kubectl config set-context $(kubectl config current-context) --namespace=dev</span><br></pre></td></tr></table></figure>


<h1 id="六、声明式对象配置（YAML）"><a href="#六、声明式对象配置（YAML）" class="headerlink" title="六、声明式对象配置（YAML）"></a>六、声明式对象配置（YAML）</h1><p>:::info<br><strong>云原生的代表技术包括：</strong><br>        ■容器<br>        ■服务网格<br>        ■微服务<br>        ■不可变基础设施<br>        ■<strong>声明式API</strong><br>:::</p>
<h2 id="管理K8S对象的方式"><a href="#管理K8S对象的方式" class="headerlink" title="管理K8S对象的方式"></a>管理K8S对象的方式</h2><p>:::danger<br>●命令行指令<br>例如，使用kubectl命令来创建和管理 Kubernetes 对象。<br>命令行就好比口头传达，简单、快速、高效。<br>但它功能有限，不适合复杂场景，操作不容易追溯，多用于开发和调试。<br>:::<br>:::danger<br><strong>●声明式配置</strong><br>kubernetes使用yaml文件来描述 Kubernetes 对象。<br>声明式配置就好比申请表，学习难度大且配置麻烦。<br>好处是操作留痕，适合操作复杂的对象，多用于生产。<br>:::</p>
<h2 id="常用命令缩写"><a href="#常用命令缩写" class="headerlink" title="常用命令缩写"></a>常用命令缩写</h2><table>
<thead>
<tr>
<th>名称</th>
<th>缩写</th>
<th>Kind</th>
</tr>
</thead>
<tbody><tr>
<td>namespaces</td>
<td>ns</td>
<td>Namespace</td>
</tr>
<tr>
<td>nodes</td>
<td>no</td>
<td>Node</td>
</tr>
<tr>
<td>pods</td>
<td>po</td>
<td>Pod</td>
</tr>
<tr>
<td>services</td>
<td>svc</td>
<td>Service</td>
</tr>
<tr>
<td>deployments</td>
<td>deploy</td>
<td>Deployment</td>
</tr>
<tr>
<td>replicasets</td>
<td>rs</td>
<td>ReplicaSet</td>
</tr>
<tr>
<td>statefulsets</td>
<td>sts</td>
<td>StatefulSet</td>
</tr>
</tbody></table>
<h2 id="YAML规范"><a href="#YAML规范" class="headerlink" title="YAML规范"></a>YAML规范</h2><blockquote>
<ul>
<li>缩进代表上下级关系</li>
<li><strong>缩进时不允许使用Tab键，只允许使用空格，通常缩进2个空格</strong></li>
<li><code>**:**</code> 键值对，后面必须有空格</li>
<li><code>**-**</code>列表，后面必须有空格</li>
<li><code>**[ ]**</code>数组</li>
<li><code>**#**</code>注释</li>
<li><code>**|**</code> 多行文本块</li>
<li><code>**---**</code>表示文档的开始，多用于分割多个资源对象</li>
</ul>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">group:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">group-1</span></span><br><span class="line">  <span class="attr">members:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;Jack Ma&quot;</span></span><br><span class="line">      <span class="attr">UID:</span> <span class="number">10001</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;Lei Jun&quot;</span></span><br><span class="line">      <span class="attr">UID:</span> <span class="number">10002</span></span><br><span class="line">    <span class="comment"># comments</span></span><br><span class="line">  <span class="attr">words:</span></span><br><span class="line">    [<span class="string">&quot;I don&#x27;t care money&quot;</span>, <span class="string">&quot;R U OK&quot;</span>]</span><br><span class="line">  <span class="attr">text:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    line</span></span><br><span class="line"><span class="string">    new line</span></span><br><span class="line"><span class="string">    3rd line</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">group:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">group-2</span></span><br><span class="line">  <span class="attr">members:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;Jack Ma&quot;</span></span><br><span class="line">      <span class="attr">UID:</span> <span class="number">10001</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;Lei Jun&quot;</span></span><br><span class="line">      <span class="attr">UID:</span> <span class="number">10002</span></span><br><span class="line">    <span class="comment"># comments</span></span><br><span class="line">  <span class="attr">words:</span></span><br><span class="line">    [<span class="string">&quot;I don&#x27;t care money&quot;</span>, <span class="string">&quot;R U OK&quot;</span>]</span><br><span class="line">  <span class="attr">text:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    line</span></span><br><span class="line"><span class="string">    new line</span></span><br><span class="line"><span class="string">    3rd line</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<h2 id="配置对象"><a href="#配置对象" class="headerlink" title="配置对象"></a>配置对象</h2><p>在创建的 Kubernetes 对象所对应的 yaml文件中，需要配置的字段如下：<br>● <code>** apiVersion **</code> - Kubernetes API 的版本<br>● <code>**kind**</code>- 对象类别，例如Pod、Deployment、Service、ReplicaSet等<br>● <code>**metadata  **</code> - 描述对象的元数据，包括一个 name 字符串、UID 和可选的 namespace<br>●<code> **spec **</code> - 对象的配置</p>
<p><strong>掌握程度：</strong><br>■不要求自己会写<br>■找模版<br>■能看懂<br>■会修改<br>■能排错</p>
<hr>
<p><strong>使用yaml定义一个Pod</strong><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/#using-pods">Pod配置模版</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.22</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>使用yaml文件管理对象</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建对象</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">my-pod.yaml</span></span><br><span class="line"><span class="comment">#编辑对象</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">edit</span> <span class="string">nginx</span></span><br><span class="line"><span class="comment">#删除对象</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">my-pod.yaml</span></span><br></pre></td></tr></table></figure>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>标签（Labels） 是附加到对象（比如 Pod）上的键值对，用于补充对象的描述信息。<br>标签使用户能够以松散的方式管理对象映射，而无需客户端存储这些映射。<br>由于一个集群中可能管理成千上万个容器，我们可以使用标签高效的进行选择和操作容器集合。<br>:::info<br><strong>键的格式：</strong>	</p>
<ul>
<li>前缀(可选)&#x2F;名称(必须)。</li>
</ul>
<p><strong>有效名称和值</strong>：</p>
<ul>
<li>必须为 63 个字符或更少（可以为空）</li>
<li>如果不为空，必须以字母数字字符（[a-z0-9A-Z]）开头和结尾</li>
<li>包含破折号-、下划线_、点.和字母或数字<br>:::<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/#syntax-and-character-set">label配置模版</a><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">label-demo</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment">#定义Pod标签</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.22</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k3s-master52 yaml]<span class="comment"># vim label-pod.yaml</span></span><br><span class="line">[root@k3s-master52 yaml]<span class="comment"># [root@k3s-master52 yaml]# kubectl apply -f label-pod.yaml</span></span><br><span class="line">pod/label-demo created</span><br><span class="line">[root@k3s-master52 yaml]<span class="comment"># kubectl get pod --show-labels</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     LABELS</span><br><span class="line">nginx-deploy-855866bb46-clg2r   1/1     Running   0          5h32m   app=nginx-deploy,pod-template-hash=855866bb46</span><br><span class="line">nginx-deploy-855866bb46-8rdbn   1/1     Running   0          5h28m   app=nginx-deploy,pod-template-hash=855866bb46</span><br><span class="line">nginx-deploy-855866bb46-qwtvj   1/1     Running   0          5h1m    app=nginx-deploy,pod-template-hash=855866bb46</span><br><span class="line">my-nginx                        1/1     Running   0          3m5s    &lt;none&gt;</span><br><span class="line">label-demo                      1/1     Running   0          11s     app=nginx,environment=<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按标签显示</span></span><br><span class="line">[root@k3s-master52 yaml]<span class="comment"># kubectl get pod -l environment=test,app=nginx</span></span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE</span><br><span class="line">label-demo   1/1     Running   0          48s</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="选择器-创建Service"><a href="#选择器-创建Service" class="headerlink" title="选择器 创建Service"></a>选择器 创建Service</h2><p><strong>标签选择器</strong> 可以识别一组对象。标签不支持唯一性。<br>标签选择器最常见的用法是为Service选择一组Pod作为后端。</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#type-nodeport">Service配置模版</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span> <span class="comment"># 对象类型为Service</span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 对象元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span> <span class="comment"># Service名为my-service</span></span><br><span class="line"><span class="attr">spec:</span>  <span class="comment"># specify 对象的配置</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 服务暴露类型为NodePort</span></span><br><span class="line">  <span class="attr">selector:</span>  <span class="comment"># service 选择器, 为service选择一组pod作为service后端</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span> <span class="comment"># 定义容器端口</span></span><br><span class="line">      <span class="comment"># 默认情况下，为了方便起见，`targetPort` 被设置为与 `port` 字段相同的值。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># 可选字段</span></span><br><span class="line">      <span class="comment"># 默认情况下，为了方便起见，Kubernetes 控制平面会从某个范围内分配一个端口号（默认：30000-32767）</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30007</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k3s-master52</span> <span class="string">yaml</span>]<span class="comment"># kubectl apply -f my-service.yaml</span></span><br><span class="line"><span class="string">service/my-service</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@k3s-master52</span> <span class="string">yaml</span>]<span class="comment"># kubectl get service</span></span><br><span class="line"><span class="string">NAME</span>            <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>      <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>          <span class="string">AGE</span></span><br><span class="line"><span class="string">kubernetes</span>      <span class="string">ClusterIP</span>   <span class="number">10.43</span><span class="number">.0</span><span class="number">.1</span>       <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>          <span class="string">2d6h</span></span><br><span class="line"><span class="string">nginx-service</span>   <span class="string">ClusterIP</span>   <span class="number">10.43</span><span class="number">.13</span><span class="number">.226</span>    <span class="string">&lt;none&gt;</span>        <span class="number">8080</span><span class="string">/TCP</span>         <span class="string">4h47m</span></span><br><span class="line"><span class="string">nginx-outside</span>   <span class="string">NodePort</span>    <span class="number">10.43</span><span class="number">.215</span><span class="number">.199</span>   <span class="string">&lt;none&gt;</span>        <span class="number">8081</span><span class="string">:31384/TCP</span>   <span class="string">3h44m</span></span><br><span class="line"><span class="string">my-service</span>      <span class="string">NodePort</span>    <span class="number">10.43</span><span class="number">.211</span><span class="number">.172</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30007/TCP</span>     <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@k3s-master52</span> <span class="string">yaml</span>]<span class="comment"># kubectl describe svc/my-service</span></span><br><span class="line"><span class="attr">Name:</span>                     <span class="string">my-service</span></span><br><span class="line"><span class="attr">Namespace:</span>                <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>                   <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:</span>              <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Selector:</span>                 <span class="string">app=nginx</span></span><br><span class="line"><span class="attr">Type:</span>                     <span class="string">NodePort</span></span><br><span class="line"><span class="attr">IP Family Policy:</span>         <span class="string">SingleStack</span></span><br><span class="line"><span class="attr">IP Families:</span>              <span class="string">IPv4</span></span><br><span class="line"><span class="attr">IP:</span>                       <span class="number">10.43</span><span class="number">.211</span><span class="number">.172</span></span><br><span class="line"><span class="attr">IPs:</span>                      <span class="number">10.43</span><span class="number">.211</span><span class="number">.172</span></span><br><span class="line"><span class="attr">Port:</span>                     <span class="string">&lt;unset&gt;</span>  <span class="number">80</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">TargetPort:</span>               <span class="number">80</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">NodePort:</span>                 <span class="string">&lt;unset&gt;</span>  <span class="number">30007</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">Endpoints:</span>                <span class="number">10.42</span><span class="number">.1</span><span class="number">.14</span><span class="string">:80</span></span><br><span class="line"><span class="attr">Session Affinity:</span>         <span class="string">None</span></span><br><span class="line"><span class="attr">External Traffic Policy:</span>  <span class="string">Cluster</span></span><br><span class="line"><span class="attr">Events:</span>                   <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<p>目前支持两种类型的选择运算：<strong>基于等值的</strong>和<strong>基于集合的</strong>。<br>多个选择条件使用逗号分隔，相当于**And(&amp;&amp;)**运算。</p>
<ul>
<li><p>等值选择</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span> <span class="comment"># component=redis &amp;&amp; version=7.0</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">7.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>集合选择</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">matchExpressions:</span> <span class="comment"># tier in (cache, backend) &amp;&amp; environment not in (dev, prod)</span></span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">tier</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">cache</span>, <span class="string">backend</span>]&#125;</span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">environment</span>, <span class="attr">operator:</span> <span class="string">NotIn</span>, <span class="attr">values:</span> [<span class="string">dev</span>, <span class="string">prod</span>]&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>参考资料：<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/kubernetes-objects/">https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/kubernetes-objects/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/object-management/">https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/object-management/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/#resource-types">https://kubernetes.io/docs/reference/kubectl/#resource-types</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/">https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/</a></p>
<h1 id="七、金丝雀发布"><a href="#七、金丝雀发布" class="headerlink" title="七、金丝雀发布"></a>七、金丝雀发布</h1><p>:::info<br><strong>金丝雀部署(canary deployment)也被称为灰度发布。</strong><br>早期，工人下矿井之前会放入一只金丝雀检测井下是否存在有毒气体。<br>采用金丝雀部署，你可以在生产环境的基础设施中小范围的部署新的应用代码。<br>一旦应用签署发布，只有少数用户被路由到它，最大限度的降低影响。<br>如果没有错误发生，则将新版本逐渐推广到整个基础设施。<br>:::<br><img src="https://cdn.nlark.com/yuque/0/2022/png/28915315/1663905517618-074351d1-bdc4-4a33-b9de-55d8bfa4c95b.png?x-oss-process=image/resize,w_589,limit_0#averageHue=%23f7f7f7&from=url&id=WjUyO&originHeight=390&originWidth=589&originalType=binary&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h2 id="部署过程"><a href="#部署过程" class="headerlink" title="部署过程"></a>部署过程</h2><p><img src="https://cdn.nlark.com/yuque/0/2022/png/28915315/1665656300936-3dff684a-d5da-4165-b70f-a28f183b57f6.png?x-oss-process=image/resize,w_607,limit_0#averageHue=%23fbfcf7&from=url&id=gABjk&originHeight=376&originWidth=607&originalType=binary&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h2 id="部署V1版本-nginx-deployment-v1"><a href="#部署V1版本-nginx-deployment-v1" class="headerlink" title="部署V1版本 nginx-deployment-v1"></a>部署V1版本 nginx-deployment-v1</h2><p>发布v1版本的应用，镜像使用<code>nginx:1.22</code>,数量为 3。</p>
<ul>
<li><strong>创建Namespace</strong></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/namespaces/#creating-a-new-namespace">Namespace配置模版</a></p>
<ul>
<li><strong>创建Deployment</strong></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment">Deployment配置模版</a></p>
<ul>
<li><strong>创建外部访问的Service</strong></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport">Service配置模版</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment-v1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deployment-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="comment"># 跟template.metadata.labels一致</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.22</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 更Deployment中的selector一致</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># By default and for convenience, the `targetPort` is set to the same value as the `port` field.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># Optional field</span></span><br><span class="line">      <span class="comment"># By default and for convenience, the Kubernetes control plane will allocate a port from a range (default: 30000-32767)</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30008</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建yaml文件，配置服务内容</span></span><br><span class="line">vim ~/deploy-v1.yaml</span><br><span class="line"><span class="comment"># 通过yaml创建</span></span><br><span class="line"><span class="comment"># Namespace:dev</span></span><br><span class="line"><span class="comment"># deploy:nginx-deployment-v1 </span></span><br><span class="line"><span class="comment"># Service: canary-demo</span></span><br><span class="line">kubectl apply -f ~/deploy-v1.yaml</span><br><span class="line"><span class="comment"># 查看服务canary-demo详情</span></span><br><span class="line">kubectl describe service canary-demo -n=dev</span><br></pre></td></tr></table></figure>
<h2 id="部署V2版本-nginx-deployment-canary"><a href="#部署V2版本-nginx-deployment-canary" class="headerlink" title="部署V2版本 nginx-deployment-canary"></a>部署V2版本 nginx-deployment-canary</h2><h3 id="创建Canary-Deployment"><a href="#创建Canary-Deployment" class="headerlink" title="创建Canary Deployment"></a>创建Canary Deployment</h3><p>发布新版本的应用，镜像使用docker&#x2F;getting-started，数量为 1。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment-canary</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deployment-canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="comment"># 跟template.metadata.labels一致</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">track:</span> <span class="string">canary</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">new-nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker/getting-started</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发布服务新版本</span></span><br><span class="line">kubectl apply -f deploy-canary.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详情</span></span><br><span class="line">kubectl describe service canary-demo -n=dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将新版本服务扩容</span></span><br><span class="line">kubectl scale deploy nginx-deployment-canary --replicas=3 -n=dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将旧服务下线</span></span><br><span class="line">kubectl scale deploy nginx-deployment-v1 --replicas=0 -n=dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空环境</span></span><br><span class="line">kubectl delete all --all -n=dev</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>局限性</strong><br>按照 Kubernetes 默认支持的这种方式进行金丝雀发布，有一定的局限性：</p>
<ul>
<li>不能根据用户注册时间、地区等请求中的内容属性进行流量分配</li>
<li>同一个用户如果多次调用该 Service，有可能第一次请求到了旧版本的 Pod，第二次请求到了新版本的 Pod</li>
</ul>
</blockquote>
<p>在 Kubernetes 中不能解决上述局限性的原因是：Kubernetes Service 只在 TCP 层面解决负载均衡的问题，并不对请求响应的消息内容做任何解析和识别。如果想要更完善地实现金丝雀发布，可以考虑Istio灰度发布。</p>
<p>参考文档：<br><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/lei4vsfpiw5a6en-aso4">https://www.infoq.cn/article/lei4vsfpiw5a6en-aso4</a><br><a target="_blank" rel="noopener" href="https://kuboard.cn/learning/k8s-intermediate/workload/wl-deployment/canary.html">https://kuboard.cn/learning/k8s-intermediate/workload/wl-deployment/canary.html</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/12/14/database/" rel="prev" title="数据库笔记">
      <i class="fa fa-chevron-left"></i> 数据库笔记
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/13/suanfa/" rel="next" title="动态规划经典问题">
      动态规划经典问题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81K3S-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">1.</span> <span class="nav-text">一、K3S 集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="nav-number">1.1.</span> <span class="nav-text">运行环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.2.</span> <span class="nav-text">1.准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85"><span class="nav-number">1.3.</span> <span class="nav-text">2.下载安装包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%89%A7%E8%A1%8C%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.</span> <span class="nav-text">3.执行安装脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1-cni0"><span class="nav-number">1.5.</span> <span class="nav-text">虚拟网卡 cni0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%92%E6%9F%A5%E9%94%99%E8%AF%AF"><span class="nav-number">1.6.</span> <span class="nav-text">排查错误</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="nav-number">2.</span> <span class="nav-text">二、镜像加速</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8K3s%E4%B8%AD%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="nav-number">2.1.</span> <span class="nav-text">在K3s中配置镜像仓库</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%88%9B%E5%BB%BA%E5%92%8C%E7%AE%A1%E7%90%86Pod"><span class="nav-number">3.</span> <span class="nav-text">三、创建和管理Pod</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86Deployment-%E9%83%A8%E7%BD%B2-%E4%B8%8EReplicaSet-%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">3.1.</span> <span class="nav-text">创建管理Deployment(部署)与ReplicaSet(副本集)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAdeployment%E5%92%8Creplicaset"><span class="nav-number">3.2.</span> <span class="nav-text">创建deployment和replicaset</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod%E8%87%AA%E6%84%88%E5%8A%9F%E8%83%BD"><span class="nav-number">3.3.</span> <span class="nav-text">Pod自愈功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod%E7%BC%A9%E6%94%BE%E5%8A%9F%E8%83%BD"><span class="nav-number">3.4.</span> <span class="nav-text">Pod缩放功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="nav-number">3.5.</span> <span class="nav-text">滚动更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E5%9B%9E%E6%BB%9A"><span class="nav-number">3.6.</span> <span class="nav-text">版本回滚</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Service-%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.</span> <span class="nav-text">四、Service 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%8E%E8%AE%BF%E9%97%AEService%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.0.1.</span> <span class="nav-text">创建与访问Service对象</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Namespace%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">5.</span> <span class="nav-text">五、Namespace命名空间</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">5.1.</span> <span class="nav-text">使用多个命名空间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">5.2.</span> <span class="nav-text">管理命名空间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%87%E6%8D%A2%E5%BD%93%E5%89%8D%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">5.3.</span> <span class="nav-text">切换当前命名空间</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE%EF%BC%88YAML%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">六、声明式对象配置（YAML）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%A1%E7%90%86K8S%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">6.1.</span> <span class="nav-text">管理K8S对象的方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E7%BC%A9%E5%86%99"><span class="nav-number">6.2.</span> <span class="nav-text">常用命令缩写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YAML%E8%A7%84%E8%8C%83"><span class="nav-number">6.3.</span> <span class="nav-text">YAML规范</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%AF%B9%E8%B1%A1"><span class="nav-number">6.4.</span> <span class="nav-text">配置对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%87%E7%AD%BE"><span class="nav-number">6.5.</span> <span class="nav-text">标签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%99%A8-%E5%88%9B%E5%BB%BAService"><span class="nav-number">6.6.</span> <span class="nav-text">选择器 创建Service</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83"><span class="nav-number">7.</span> <span class="nav-text">七、金丝雀发布</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B"><span class="nav-number">7.1.</span> <span class="nav-text">部署过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2V1%E7%89%88%E6%9C%AC-nginx-deployment-v1"><span class="nav-number">7.2.</span> <span class="nav-text">部署V1版本 nginx-deployment-v1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2V2%E7%89%88%E6%9C%AC-nginx-deployment-canary"><span class="nav-number">7.3.</span> <span class="nav-text">部署V2版本 nginx-deployment-canary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BACanary-Deployment"><span class="nav-number">7.3.1.</span> <span class="nav-text">创建Canary Deployment</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">SoarYu</p>
  <div class="site-description" itemprop="description">Done is better than perfect!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SoarYu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
